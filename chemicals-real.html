<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zero@Production Chemicals & Dye DPP</title>
    <link rel="stylesheet" href="assets/css/theme.css" />
    <link rel="stylesheet" href="assets/css/zae-theme.css" />
    <!-- Chart.js removed for native implementation -->
    <script defer src="assets/js/main.min.js"></script>
    <style>
      /* ZERO_CHEM_STACK_CSS_V1 */
      #chemStackLegend .lg{
        display:inline-flex; align-items:center; gap:8px;
        padding:6px 10px; border:1px solid #eef2f7; border-radius:999px;
        background:#fff;
      }
      #chemStackLegend .dot{ width:10px; height:10px; border-radius:3px; display:inline-block; }

      /* ZERO_EXEC_CLICKFIX_CHEM v1 */
      .exec-lenses, .exec-grid, .exec-card{position:relative; z-index:5;}
      .exec-card{pointer-events:auto !important; cursor:pointer;}
      .zero-modal{z-index:9999;}
      .exec-card.is-focus{outline:3px solid #f9ba00; box-shadow:0 0 0 6px rgba(249,186,0,.18);}
      
      /* ZERO: EXECUTIVE LENSES CSS */
      .exec-grid{ 
        display:grid; 
        grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); 
        gap:14px; 
      } 
      .exec-card{ 
        background:#fff; 
        border:1px solid #e0e0e0; 
        border-radius:8px; 
        padding:14px; 
        cursor:pointer; 
        pointer-events:auto; 
      } 
      .zero-modal{ 
        position:fixed; 
        inset:0; 
        background:rgba(0,0,0,.45); 
        display:none; 
        z-index:9999; 
      } 
      .zero-modal[aria-hidden="false"]{ display:flex; } 
      .zero-modal-box{ 
        background:#fff; 
        margin:auto; 
        padding:20px; 
        max-width:520px; 
        width:90%; 
        border-radius:10px; 
      }
      .exec-metric { font-size: 24px; font-weight: 800; color: #02154e; margin: 8px 0; }
      .exec-sub { font-size: 12px; color: #666; }

      /* ZERO: PDF REPORT PRINT STYLES */
      @media print {
        @page { size: A4; margin: 0; }
        body { background: #fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .app-header, .zero-color-bar, .container, .zero-modal, .btn, #chemicalsClearFilter, #chemicalsTimeframe { display: none !important; }
        .print-only-report { display: block !important; }
        .print-page { 
          width: 210mm; 
          height: 297mm; 
          padding: 20mm; 
          page-break-after: always; 
          position: relative; 
          box-sizing: border-box;
        }
        .print-page:last-child { page-break-after: auto; }
        .print-header { border-bottom: 2px solid #02154e; margin-bottom: 20px; padding-bottom: 10px; }
        .print-logo { height: 40px; }
        .print-title { font-size: 24px; font-weight: 800; color: #02154e; }
        .print-sub { font-size: 14px; color: #666; margin-top: 5px; }
        .print-section { margin-top: 30px; }
        .print-section h3 { color: #02154e; border-left: 4px solid #f9ba00; padding-left: 10px; }
        .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .print-card { background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #eee; }
        .print-metric { font-size: 20px; font-weight: bold; color: #02154e; }
        .print-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        .risk-high { color: #D51635; }
        .risk-safe { color: #005530; }
      }
      .print-only-report { display: none; }
    </style>
  

<style>
  :root{
    --zero-navy:#02154e;
    --zero-green:#005530;
    --zero-red:#D51635;
    --zero-orange:#f9ba00;
    --ink:#0b1020;
    --muted:#6b7280;
    --bg:#f7f8fb;
    --card:#ffffff;
    --line:#e6e8ef;
  }
  .zd-wrap{max-width:1180px;margin:0 auto;padding:18px;}
  .zd-hero{
    background:linear-gradient(180deg,#0c1a55 0%, #02154e 100%);
    color:#fff;border-radius:16px;padding:18px 18px 14px 18px;
    box-shadow:0 10px 24px rgba(2,21,78,.18);
  }
  .zd-hero h1{margin:0;font-size:20px;letter-spacing:.2px}
  .zd-hero .sub{margin:6px 0 0 0;color:rgba(255,255,255,.82);font-size:13px}
  .zd-pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .zd-pill{
    display:inline-flex;align-items:center;gap:6px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.10);
    padding:6px 10px;border-radius:999px;font-size:12px;
  }
  .zd-pill strong{font-weight:700}
  .zd-pill.orange{background:rgba(249,186,0,.14);border-color:rgba(249,186,0,.28)}
  .zd-pill.green{background:rgba(0,85,48,.18);border-color:rgba(0,85,48,.35)}
  .zd-pill.red{background:rgba(213,22,53,.16);border-color:rgba(213,22,53,.35)}

  .zd-grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
  @media(min-width:980px){.zd-grid{grid-template-columns:1fr 1fr}}

  .zd-card{
    background:var(--card);border:1px solid var(--line);
    border-radius:14px;padding:14px;
    box-shadow:0 8px 18px rgba(2,21,78,.06);
  }
  .zd-card h2{margin:0 0 8px 0;font-size:15px;color:var(--zero-navy)}
  .zd-card .hint{margin:0 0 10px 0;color:var(--muted);font-size:12px}

  .kpi-row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  @media(min-width:980px){.kpi-row{grid-template-columns:repeat(3,minmax(0,1fr));}}
  .kpi{
    border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff;
  }
  .kpi .lbl{font-size:11px;color:var(--muted);margin-bottom:6px}
  .kpi .val{font-size:18px;font-weight:800;color:var(--ink);letter-spacing:.2px}
  .kpi .sub{font-size:11px;color:var(--muted);margin-top:4px}
  .kpi.ok{border-color:rgba(0,85,48,.35);background:rgba(0,85,48,.04)}
  .kpi.warn{border-color:rgba(249,186,0,.45);background:rgba(249,186,0,.06)}
  .kpi.bad{border-color:rgba(213,22,53,.45);background:rgba(213,22,53,.05)}

  .zd-table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border:1px solid var(--line);border-radius:12px}
  .zd-table th,.zd-table td{padding:10px;border-bottom:1px solid var(--line);font-size:12px;vertical-align:top}
  .zd-table th{background:#f6f7fb;color:var(--zero-navy);text-align:left;font-weight:800}
  .zd-table tr:last-child td{border-bottom:none}
  .tag{display:inline-flex;padding:3px 8px;border-radius:999px;font-size:11px;border:1px solid var(--line);background:#fff}
  .tag.ok{border-color:rgba(0,85,48,.35);background:rgba(0,85,48,.06)}
  .tag.bad{border-color:rgba(213,22,53,.45);background:rgba(213,22,53,.06)}
  .tag.warn{border-color:rgba(249,186,0,.55);background:rgba(249,186,0,.08)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .small{font-size:11px;color:var(--muted)}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .btn{
    appearance:none;border:1px solid var(--line);background:#fff;color:var(--zero-navy);
    padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer;font-size:12px;
  }
  .btn.orange{background:var(--zero-orange);border-color:rgba(0,0,0,.08);color:#111}
  .btn.navy{background:var(--zero-navy);border-color:rgba(255,255,255,.18);color:#fff}
  .btn:hover{filter:brightness(.98)}
</style>

</head>
  <body>


    <div class="zero-color-bar"></div>
    <header class="app-header">
    <div class="header-content">
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
            <a href="index.html" style="text-decoration: none; display: flex; align-items: center;">
                <img src="assets/img/plogo.svg" alt="Zero Logo" style="height: 80px; margin-right: 15px;">
                <div class="title">Zero <span class="title-at">Ecosystem</span> Chemicals & Dye DPP by Zero<span class="title-at">@</span>Ecosystem</div>
            </a>
        </div>
    </div>
</header>
    <main class="container">
      <div class="card" style="margin-bottom: 24px;">
        <div class="row" style="justify-content: space-between; align-items: center;">
          <div>
            <h3>Chemicals & Dyes — Total CO2? and Cost</h3>
            <p class="muted">Process metrics by time range</p>
          </div>
          <div class="row" style="gap:8px; align-items:center;">
            <!-- ZERO: FACILITY SWITCHER -->
            <label for="chemFacilitySelect" class="muted" style="font-weight:bold; color:#02154e;">Facility:</label>
            <select id="chemFacilitySelect" class="btn" style="background:#f9ba00; color:#02154e; font-weight:bold; border:none;">
              <option value="ekoten">? Ekoten (Izmir)</option>
              <option value="bossa">? Bossa (Adana)</option>
              <option value="isko">? ISKO (Inegol)</option>
              <option value="kivanc">? Kivanc (Adana)</option>
            </select>
            <button class="btn" onclick="window.print()" style="background:#02154e;color:#fff;">? Export Report (PDF)</button>
            <label for="chemicalsTimeframe" class="muted">Range:</label>
            <select id="chemicalsTimeframe" class="btn" style="background: rgba(255,255,255,0.1); min-width:120px;"></select>
            <span id="chemicalsActiveFilter" class="muted" style="margin-left:16px;">Filter: </span>
            <button id="chemicalsClearFilter" class="btn" style="margin-left:8px;">Clear Filter</button>
          </div>
        </div>
        <div class="row" style="gap:32px; align-items:flex-start;">
          <div class="card" style="min-width:260px;">
            <h3 id="chemicalsTotalCo2"></h3>
            <p class="muted">Total CO2?</p>
          </div>
          <div class="card" style="min-width:260px;">
            <h3 id="chemicalsTotalCost"></h3>
            <p class="muted">Estimated Cost (K)</p>
          </div>
        </div>
      </div>

      <!-- ZERO: EXECUTIVE LENSES HTML -->
      <section class="exec-lenses" style="margin-bottom: 24px;"> 
        <div style="font-size:14px;color:#02154e;font-weight:800;margin-bottom:6px;"> 
          Executive Decision Lenses — Chemicals 
        </div> 
      
        
<!-- ZD_CHEM_JUMPS_START -->
<div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 14px 0;">
  <button class="btn btn-sm" type="button" onclick="document.getElementById('zd_compliance')?.scrollIntoView({behavior:'smooth',block:'start'})">Compliance</button>
  <button class="btn btn-sm" type="button" onclick="document.getElementById('zd_etp')?.scrollIntoView({behavior:'smooth',block:'start'})">ETP / Discharge</button>
  <button class="btn btn-sm" type="button" onclick="document.getElementById('zd_cost')?.scrollIntoView({behavior:'smooth',block:'start'})">Cost & Volatility</button>
  <button class="btn btn-sm" type="button" onclick="document.getElementById('zd_ops')?.scrollIntoView({behavior:'smooth',block:'start'})">Ops Risk</button>
</div>
<!-- ZD_CHEM_JUMPS_END -->
<div class="exec-grid"> 
          <div class="exec-card" data-role="CEO"> 
            <h4>CEO Compliance</h4> 
            <div class="exec-metric" style="color:#005530">Safe</div> 
            <div class="exec-sub">Risk Score: Low</div> 
          </div> 
      
          <div class="exec-card" data-role="CFO"> 
            <h4>CFO Cost Risk</h4> 
            <div class="exec-metric">240K</div> 
            <div class="exec-sub">Annual Exposure</div> 
          </div> 
      
          <div class="exec-card" data-role="CTO"> 
            <h4>CTO Traceability</h4> 
            <div class="exec-metric">94%</div> 
            <div class="exec-sub">ML-Ready: YES</div> 
          </div> 
      
          <div class="exec-card" data-role="MD"> 
            <h4>MD/COO — Ops Risk</h4> 
            <div class="exec-metric">0.2%</div> 
            <div class="exec-sub">Quality Deviation</div> 
          </div> 
        </div> 
      </section>

      <section class="card" id="trendSection" style="margin-bottom: 24px;">
        <h3>Trend</h3>
        <div id="chemicalsTrendSummary" class="muted skeleton skeleton-text"></div>
        <div id="chemicalsTrendCostSummary" class="muted skeleton skeleton-text"></div>
      </section>

      <!-- Module Cost & CO2? Share (Stacked) -->
      <div class="card" style="margin-top:14px; margin-bottom:24px;">
        <div style="padding:16px 18px;border-bottom:1px solid #eef2f7;">
          <div style="font-weight:900;color:#02154e;font-size:16px;">Module Cost &amp; CO2? Share (Stacked)</div>
          <div style="color:#6b7280;font-size:12px;margin-top:4px;">Distribution of financial and environmental impact</div>
        </div>
        <div style="padding:14px 18px;">
          <canvas id="chemStackCanvas" style="width:100%;height:220px;display:block;"></canvas>
          <div id="chemStackLegend" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;font-size:12px;color:#6b7280;"></div>
        </div>
      </div>

      <section class="card" style="margin-bottom: 24px;">
        <h3>Chemicals/Dyes CO2? (Modules)</h3>
        <div style="height:220px;margin-top:10px;">
          <canvas id="chemTrendCanvas" width="1100" height="220" style="width:100%;height:220px;border-radius:14px;background:#fff;border:1px solid rgba(2,21,78,.08);"></canvas>
        </div>
      </section>



      <section class="card">
        <h3>Chemicals & Dyes Module Table</h3>
        <p class="muted">CO2? and cost (K) scaled by time range</p>
        <table class="table-hover" style="width:100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:8px;">Module</th>
              <th style="text-align:left; padding:8px;">Area</th>
              <th style="text-align:left; padding:8px;">CO2?</th>
              <th style="text-align:left; padding:8px;">Cost</th>
              <th style="text-align:left; padding:8px;">Status</th>
            </tr>
          </thead>
          <tbody id="chemicalsTbody"></tbody>
        </table>
      </section>
    </main>

    <!-- ZERO: MODAL -->
    <div class="zero-modal" id="chemExecModal" aria-hidden="true"> 
      <div class="zero-modal-box"> 
        <button class="zero-modal-close" id="chemExecClose" style="float:right;border:none;background:none;font-size:1.2rem;cursor:pointer;"></button> 
        <h3 id="chemModalTitle" style="margin-top:0;color:#02154e;"></h3> 
        <p id="chemModalSub" style="color:#666;font-size:0.9rem;margin-bottom:1rem;"></p> 
        <div id="chemModalContent"></div> 
      </div> 
    </div>

    <!-- ZERO: PRINT REPORT STRUCTURE (Hidden on screen) -->
    <div class="print-only-report">
      <!-- Page 1: Executive Summary -->
      <div class="print-page">
        <div class="print-header">
          <img src="assets/img/plogo.svg" class="print-logo" alt="Zero Logo">
          <div style="float:right; font-size:12px; color:#999;">Generated: ${new Date().toLocaleDateString()}</div>
        </div>
        <div class="print-title">Chemical Risk & Cost Exposure</div>
        <div class="print-sub">Executive Report Zero@Production Ecosystem</div>
        
        <div class="print-section">
          <h3>Executive Summary</h3>
          <p>High-level assessment of chemical inventory, compliance status, and financial exposure across all active production units.</p>
          <div class="print-grid" style="margin-top:20px;">
            <div class="print-card">
              <div class="print-label">Total Chemical Spend (Q3)</div>
              <div class="print-metric" id="printTotalSpend">240,000</div>
              <div style="font-size:12px; color:#005530; margin-top:5px;">5% vs previous quarter</div>
            </div>
            <div class="print-card">
              <div class="print-label">Compliance Status</div>
              <div class="print-metric risk-safe" id="printComplianceStatus">SAFE</div>
              <div style="font-size:12px; color:#666; margin-top:5px;">ZDHC Level 3 Certified</div>
            </div>
            <div class="print-card">
              <div class="print-label">Traceability Score</div>
              <div class="print-metric" id="printTraceability">94%</div>
              <div style="font-size:12px; color:#666; margin-top:5px;">Lot-level data completeness</div>
            </div>
            <div class="print-card">
              <div class="print-label">Active Suppliers</div>
              <div class="print-metric" id="printSuppliers">12</div>
              <div style="font-size:12px; color:#005530; margin-top:5px;">0 Red Flag Suppliers</div>
            </div>
          </div>
        </div>

        <div class="print-section">
          <h3>Top 5 High-Risk Chemicals</h3>
          <p style="font-size:13px; color:#666; margin-bottom:15px;">Priority mitigation targets based on Risk Score (>60).</p>
          <table style="width:100%; font-size:12px; border-collapse:collapse;">
            <thead>
              <tr style="border-bottom:2px solid #02154e; text-align:left;">
                <th style="padding:8px;">Chemical Name</th>
                <th style="padding:8px;">Risk Score</th>
                <th style="padding:8px;">Hazard Flags</th>
                <th style="padding:8px;">Action</th>
              </tr>
            </thead>
            <tbody id="printRiskTableBody">
              <!-- Dynamically populated -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Page 2: CEO Lens -->
      <div class="print-page">
        <div class="print-header"><div class="print-title">CEO Lens: Compliance & Reputation</div></div>
        <div class="print-section">
          <h3>Compliance Heatmap</h3>
          <p>Regulatory exposure analysis based on ZDHC, REACH, and customer RSL requirements.</p>
          <div class="print-card" style="margin-top:20px;">
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding:10px 0;">
              <span>ZDHC Level 3 Certification</span>
              <strong class="risk-safe">Active</strong>
            </div>
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding:10px 0;">
              <span>Restricted Substances (RSL) Breaches</span>
              <strong class="risk-safe">0 Incidents</strong>
            </div>
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding:10px 0;">
              <span>Red Flag Suppliers</span>
              <strong class="risk-safe">None</strong>
            </div>
            <div style="display:flex; justify-content:space-between; padding:10px 0;">
              <span>Audit Score (Last 12 Months)</span>
              <strong>98/100</strong>
            </div>
          </div>
        </div>
      </div>

      <!-- Page 3: CFO Lens -->
      <div class="print-page">
        <div class="print-header"><div class="print-title">CFO Lens: Financial Exposure</div></div>
        <div class="print-section">
          <h3>Cost Volatility & Risk</h3>
          <div class="print-grid">
            <div class="print-card">
              <div class="print-label">Risk-Adjusted Annual Exposure</div>
              <div class="print-metric" id="printCfoExposure">240K</div>
            </div>
            <div class="print-card">
              <div class="print-label">Substitute Chemical Cost Delta</div>
              <div class="print-metric risk-high">+12%</div>
            </div>
          </div>
          <div class="print-card" style="margin-top:20px;">
            <h4>Input Cost Volatility Analysis</h4>
            <p style="font-size:13px; color:#666;">Market fluctuations for key dye intermediates show moderate volatility.</p>
            <div style="margin-top:10px; height:150px; background:#eee; display:flex; align-items:center; justify-content:center; color:#999;">
              [Cost Chart Placeholder for PDF]
            </div>
          </div>
        </div>
      </div>

      <!-- Page 4: CTO Lens -->
      <div class="print-page">
        <div class="print-header"><div class="print-title">CTO Lens: Data & Traceability</div></div>
        <div class="print-section">
          <h3>Digital Passport Readiness</h3>
          <ul style="list-style:none; padding:0;">
            <li style="padding:10px; background:#f8f9fa; margin-bottom:5px; display:flex; justify-content:space-between;">
              <span>Traceability Completeness</span>
              <strong id="printCtoTraceability">94%</strong>
            </li>
            <li style="padding:10px; background:#f8f9fa; margin-bottom:5px; display:flex; justify-content:space-between;">
              <span>Missing MSDS / CAS Data</span>
              <strong class="risk-high">2 Gaps Detected</strong>
            </li>
            <li style="padding:10px; background:#f8f9fa; margin-bottom:5px; display:flex; justify-content:space-between;">
              <span>ML-Ready Dataset</span>
              <strong class="risk-safe">YES</strong>
            </li>
          </ul>
        </div>
      </div>

      <!-- Page 5: MD Lens -->
      <div class="print-page">
        <div class="print-header"><div class="print-title">MD Lens: Operational Stability</div></div>
        <div class="print-section">
          <h3>Quality & Efficiency</h3>
          <div class="print-grid">
            <div class="print-card">
              <div class="print-label">Quality Deviation Risk</div>
              <div class="print-metric risk-safe">Low</div>
            </div>
            <div class="print-card">
              <div class="print-label">Rework / Fire Proxy</div>
              <div class="print-metric" id="printMdRework">0.2%</div>
            </div>
          </div>
          <p style="margin-top:20px;">Operational stability index is high, with minor deviations in Recipe #402.</p>
        </div>
      </div>
    </div>

    <!-- ZERO_CHEMICALS_CORE v4: Fleet Demo Pack + Modules + Chart -->
    <script>
    (function(){
      // --- DATA: FACILITY FLEET PACK (Ekoten + Benchmark) ---
      const FLEET_DATA = {
        "ekoten": {
          label: "Ekoten Dyehouse (TR-IZM) Core Demo",
          meta: { city:"Izmir", focus:["knitting","reactive","finishing"], wwtp:true, zdhc:"level-3", notes:["anchor customer","high compliance"] },
          kpis: { co2_t: 28.4, est_cost_eur: 240000, compliance:"SAFE", co2_trend:-4.2, cost_trend:-1.5 },
          dataHealth: { completeness: 0.98, sds:1.0, cas:1.0, batchTrace:0.94 },
          inventory: [
            {name:"Reactive Black 5", cat:"Reactive Dye", flags:[], risk:35, co2:2.1, substitute:"n/a"},
            {name:"Reactive Blue 19", cat:"Reactive Dye", flags:["AOX-potential"], risk:38, co2:2.4, substitute:"Low-salt reactive"},
            {name:"Disperse Blue 79", cat:"Disperse Dye", flags:["skin sens."], risk:42, co2:2.8, substitute:"Eco-disperse"},
            {name:"Sodium Sulphate", cat:"Salt", flags:["salinity"], risk:25, co2:0.4, substitute:"n/a"},
            {name:"Soda Ash", cat:"Alkali", flags:[], risk:20, co2:0.9, substitute:"n/a"},
            {name:"Acetic Acid", cat:"Acid", flags:["corrosive"], risk:30, co2:1.1, substitute:"Citric acid"},
            {name:"Softener Flake", cat:"Softener", flags:[], risk:15, co2:0.8, substitute:"n/a"},
            {name:"Enzyme Bio-Polish", cat:"Enzyme", flags:["bio"], risk:10, co2:0.3, substitute:"n/a"},
            {name:"Sequestering Agent", cat:"Auxiliary", flags:["EDTA-free"], risk:12, co2:0.5, substitute:"n/a"},
            {name:"Wetting Agent", cat:"Auxiliary", flags:[], risk:18, co2:0.6, substitute:"n/a"},
            {name:"Defoamer Si-Free", cat:"Auxiliary", flags:[], risk:14, co2:0.4, substitute:"n/a"},
            {name:"Fixing Agent LF", cat:"Auxiliary", flags:["low-formaldehyde"], risk:45, co2:1.2, substitute:"Zero-F"},
            {name:"Levelling Agent", cat:"Auxiliary", flags:[], risk:22, co2:0.7, substitute:"n/a"},
            {name:"Optical Brightener", cat:"OBA", flags:["aquatic-tox"], risk:48, co2:1.5, substitute:"Eco-OBA"},
            {name:"Hydrogen Peroxide", cat:"Bleach", flags:["oxidizer"], risk:28, co2:0.8, substitute:"n/a"}
          ]
        },
        "bossa": {
          label: "Bossa (Adana) High Volume Denim",
          meta: { city:"Adana", focus:["denim","indigo","washing"], wwtp:true, zdhc:"active", notes:["high throughput","cost volatility sensitive"] },
          kpis: { co2_t: 66.0, est_cost_eur: 1200000, compliance:"MONITOR", co2_trend:+2.1, cost_trend:+3.4 },
          dataHealth: { completeness: 0.78, sds:0.84, cas:0.76, batchTrace:0.61 },
          inventory: [
            {name:"Indigo Granular", cat:"Vat Dye", flags:["wastewater-load"], risk:48, co2:2.8, substitute:"Foam dyeing"},
            {name:"Sodium Hydrosulfite", cat:"Reducing Agent", flags:["sulfite"], risk:67, co2:2.4, substitute:"Lower dosage control"},
            {name:"Potassium Permanganate", cat:"Washing Chem", flags:["oxidizer"], risk:72, co2:1.9, substitute:"Ozone finishing"},
            {name:"Enzyme Cellulase", cat:"Enzyme", flags:["bio"], risk:18, co2:0.3, substitute:"n/a"},
            {name:"Solvent Spot Remover", cat:"Solvent", flags:["VOC"], risk:64, co2:1.5, substitute:"Water-based"},
            {name:"Resin Fix NF", cat:"Finishing Resin", flags:["formaldehyde"], risk:73, co2:1.2, substitute:"Formaldehyde-free"},
            {name:"Disperse Dye Mix", cat:"Disperse Dye", flags:["carrier"], risk:52, co2:1.4, substitute:"Carrier-free"},
            {name:"Caustic Soda", cat:"Alkali", flags:["corrosive"], risk:58, co2:1.6, substitute:"Process optimization"},
            {name:"Softener C-88", cat:"Softener", flags:["aquatic-tox"], risk:41, co2:0.6, substitute:"ZDHC grade"},
            {name:"Anti-backstain A-10", cat:"Auxiliary", flags:["restricted-check"], risk:49, co2:0.8, substitute:"Approved alt"}
          ]
        },
        "isko": {
          label: "ISKO Traceability-led Denim (Benchmark)",
          meta: { city:"T??rkiye", focus:["denim","R&D"], wwtp:true, zdhc:"member-signal", notes:["traceability posture","benchmark data quality"] },
          kpis: { co2_t: 44.0, est_cost_eur: 850000, compliance:"OK", co2_trend:-1.2, cost_trend:+0.4 },
          dataHealth: { completeness: 0.93, sds:0.96, cas:0.94, batchTrace:0.88 },
          inventory: [
            {name:"Indigo Granular", cat:"Vat Dye", flags:["wastewater-load"], risk:36, co2:2.2, substitute:"Optimized recipe"},
            {name:"Sodium Hydrosulfite", cat:"Reducing Agent", flags:["sulfite"], risk:54, co2:1.9, substitute:"Dose control"},
            {name:"Ozone Finish Program", cat:"Process", flags:["CAPEX"], risk:22, co2:0.2, substitute:"n/a"},
            {name:"Low-impact Softener", cat:"Softener", flags:["approved"], risk:18, co2:0.4, substitute:"n/a"},
            {name:"Reactive Dye Set", cat:"Reactive Dye", flags:["salt-load"], risk:34, co2:1.1, substitute:"Low-salt route"},
            {name:"Detergent ZDHC-grade", cat:"Auxiliary", flags:["conformant"], risk:20, co2:0.3, substitute:"n/a"}
          ]
        },
        "kivanc": {
          label: "K??van?? (Adana) Balanced Dyehouse Profile",
          meta: { city:"Adana", focus:["woven","reactive","finishing"], wwtp:true, zdhc:"in-progress", notes:["balanced risk","placeholder until public signals verified"] },
          kpis: { co2_t: 38.0, est_cost_eur: 420000, compliance:"OK", co2_trend:-0.8, cost_trend:+1.1 },
          dataHealth: { completeness: 0.82, sds:0.88, cas:0.83, batchTrace:0.69 },
          inventory: [
            {name:"Reactive Blue 19", cat:"Reactive Dye", flags:["salt-load"], risk:41, co2:1.5, substitute:"Low-salt reactive"},
            {name:"Caustic Soda", cat:"Alkali", flags:["corrosive"], risk:56, co2:1.3, substitute:"Optimization"},
            {name:"Peroxide", cat:"Bleaching", flags:["oxidizer"], risk:47, co2:0.9, substitute:"Process control"},
            {name:"Resin Fix NF", cat:"Finishing Resin", flags:["formaldehyde"], risk:69, co2:1.1, substitute:"Formaldehyde-free"},
            {name:"Softener C-88", cat:"Softener", flags:["aquatic-tox"], risk:39, co2:0.6, substitute:"ZDHC grade"}
          ]
        }
      };

      // --- STATE ---
      let currentFacility = "ekoten";
      let currentRole = null;
      let moduleChartInstance = null;

      // --- HELPERS ---
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => document.querySelectorAll(s);
      const formatMoney = (n) => "" + (n >= 1000 ? (n/1000).toFixed(0) + "K" : n);

      // --- RENDER FUNCTIONS ---
      function renderFacility(key){
        const f = FLEET_DATA[key];
        if(!f) return;

        // 1. Update Header / KPI
        const co2El = document.getElementById("chemicalsTotalCo2");
        const costEl = document.getElementById("chemicalsTotalCost");
        if(co2El) co2El.textContent = f.kpis.co2_t + "t";
        if(costEl) costEl.textContent = "" + (f.kpis.est_cost_eur/1000).toFixed(0) + "K";
        
        // 2. Update Trend (New Rich HTML) & Chart
        const series = buildSeries(f);
        paintTrend(series);
        drawChart(series);
        
        // 3. Update Print Summary Metrics
        const pSpend = document.getElementById("printTotalSpend");
        const pComp = document.getElementById("printComplianceStatus");
        const pTrace = document.getElementById("printTraceability");
        const pSupp = document.getElementById("printSuppliers");
        const pCfo = document.getElementById("printCfoExposure");
        const pCto = document.getElementById("printCtoTraceability");
        const pMd = document.getElementById("printMdRework");

        if(pSpend) pSpend.textContent = "" + (f.kpis.est_cost_eur/1000).toFixed(0) + "K";
        if(pComp) pComp.textContent = f.kpis.compliance;
        if(pTrace) pTrace.textContent = Math.round(f.dataHealth.completeness * 100) + "%";
        if(pSupp) pSupp.textContent = f.meta.focus.length * 3 + 2; // Demo logic
        if(pCfo) pCfo.textContent = "" + (f.kpis.est_cost_eur/1000).toFixed(0) + "K";
        if(pCto) pCto.textContent = Math.round(f.dataHealth.completeness * 100) + "%";
        if(pMd) pMd.textContent = (Math.random() * 0.5 + 0.1).toFixed(1) + "%"; // Demo logic

        // 4. Render Tables
        renderModules(f); // Main Module Table
        renderPdfInventory(f); // PDF Risk Table
        drawModuleBreakdown(f); // NEW: Stacked Bar Chart

        // 5. Update Exec Cards (Metrics only)
        updateExecCards(f);
      }

      function renderModules(f) {
        const tbody = $("#chemicalsTbody");
        if(!tbody) return;
        tbody.innerHTML = "";

        // Module definition logic (simulated breakdown)
        var parts = [
          { m:"Dyeing", area:"Production", pCO2:0.34, pCost:0.40, risk:"MODERATE" },
          { m:"Pre-treatment", area:"Preparation", pCO2:0.14, pCost:0.12, risk:"SAFE" },
          { m:"Finishing", area:"Finishing", pCO2:0.16, pCost:0.15, risk:"MODERATE" },
          { m:"Effluent (ETP)", area:"Compliance", pCO2:0.12, pCost:0.10, risk:"HIGH" },
          { m:"Lab & QC", area:"Quality", pCO2:0.08, pCost:0.08, risk:"SAFE" },
          { m:"Auxiliaries", area:"Purchasing", pCO2:0.16, pCost:0.15, risk:"MODERATE" }
        ];

        // Facility tweaks
        const label = f.label.toLowerCase();
        if(label.includes("bossa")){ parts[0].risk="HIGH"; parts[3].pCost=0.14; parts[3].risk="HIGH"; }
        if(label.includes("isko")){ parts[3].risk="MODERATE"; parts[4].pCO2=0.10; parts[4].risk="SAFE"; }
        if(label.includes("kivanc") || label.includes("k??van??")){ parts[1].risk="HIGH"; parts[5].pCost=0.18; }

        // Calculate absolute values
        const totalCO2 = f.kpis.co2_t;
        const totalCostK = f.kpis.est_cost_eur / 1000;

        parts.forEach(p => {
            const rowCO2 = (totalCO2 * p.pCO2).toFixed(1);
            const rowCost = "" + Math.round(totalCostK * p.pCost) + "K";
            
            // Status Badge
            let bg = "#e7f7ee", fg = "#0b7a2a";
            if(p.risk==="MODERATE"){ bg="#fff4df"; fg="#8a4b00"; }
            if(p.risk==="HIGH"){ bg="#ffe3e8"; fg="#b10f2e"; }
            const badge = `<span style="display:inline-block;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px;background:${bg};color:${fg}">${p.risk}</span>`;

            const tr = document.createElement("tr");
            tr.style.borderBottom = "1px solid #eee";
            tr.innerHTML = `
              <td style="padding:12px 8px;font-weight:bold;color:#02154e;">${p.m}</td>
              <td style="padding:12px 8px;color:#666;">${p.area}</td>
              <td style="padding:12px 8px;">${rowCO2}t</td>
              <td style="padding:12px 8px;">${rowCost}</td>
              <td style="padding:12px 8px;">${badge}</td>
            `;
            tbody.appendChild(tr);
        });
      }

      function renderPdfInventory(f) {
        // PDF Table: Top 5 Risky
        const printBody = $("#printRiskTableBody");
        if(!printBody) return;
        printBody.innerHTML = "";
        
        const sortedRisky = [...f.inventory].sort((a,b) => b.risk - a.risk).slice(0, 5);
        
        sortedRisky.forEach(item => {
          const tr = document.createElement("tr");
          tr.style.borderBottom = "1px solid #eee";
          tr.innerHTML = `
            <td style="padding:8px;"><strong>${item.name}</strong></td>
            <td style="padding:8px;color:#D51635;font-weight:bold;">${item.risk}</td>
            <td style="padding:8px;">${item.flags.join(", ")}</td>
            <td style="padding:8px;font-size:11px;">${item.substitute}</td>
          `;
          printBody.appendChild(tr);
        });
      }

      function updateExecCards(d){
        const cards = document.querySelectorAll(".exec-card");
        cards.forEach(card => {
          const role = card.getAttribute("data-role");
          const metricEl = card.querySelector(".exec-metric");
          if(role === "CEO"){
            metricEl.textContent = d.kpis.compliance;
            metricEl.className = "exec-metric " + (d.kpis.compliance === "SAFE" ? "risk-safe" : "risk-high");
            metricEl.style.color = d.kpis.compliance === "SAFE" ? "#005530" : "#D51635";
            card.querySelector(".exec-sub").textContent = `ZDHC: ${d.meta.zdhc}`;
          } else if(role === "CFO"){
            metricEl.textContent = "" + (d.kpis.est_cost_eur/1000).toFixed(0) + "K";
            card.querySelector(".exec-sub").textContent = `Trend: ${d.kpis.cost_trend}%`;
          } else if(role === "CTO"){
            metricEl.textContent = Math.round(d.dataHealth.completeness * 100) + "%";
            card.querySelector(".exec-sub").textContent = `Traceability Score`;
          } else if(role === "MD"){
            metricEl.textContent = (Math.random() * 0.5 + 0.1).toFixed(1) + "%";
            card.querySelector(".exec-sub").textContent = "Quality Deviation";
          }
        });
      }

      // --- CHART & TREND LOGIC ---
      function drawModuleBreakdown(f){
        const canvas = document.getElementById("chemStackCanvas");
        const legend = document.getElementById("chemStackLegend");
        if(!canvas) return;

        // Module definition logic (simulated breakdown)
        var parts = [
          { m:"Dyeing", c:"#02154e", pCO2:0.34, pCost:0.40 },
          { m:"Pre-treatment", c:"#005530", pCO2:0.14, pCost:0.12 },
          { m:"Finishing", c:"#f9ba00", pCO2:0.16, pCost:0.15 },
          { m:"Effluent (ETP)", c:"#d51635", pCO2:0.12, pCost:0.10 },
          { m:"Lab & QC", c:"#6b7280", pCO2:0.08, pCost:0.08 },
          { m:"Auxiliaries", c:"#3b82f6", pCO2:0.16, pCost:0.15 }
        ];

        // Facility tweaks
        const label = f.label.toLowerCase();
        if(label.includes("bossa")){ parts[3].pCost=0.14; }
        if(label.includes("isko")){ parts[4].pCO2=0.10; }
        if(label.includes("kivanc") || label.includes("k??van??")){ parts[5].pCost=0.18; }

        // Native Canvas Drawing (No Chart.js)
        // HiDPI Setup
        var dpr = window.devicePixelRatio || 1;
        var rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        var ctx = canvas.getContext("2d");
        ctx.scale(dpr, dpr);
        var w = rect.width;
        var h = rect.height;

        ctx.clearRect(0,0,w,h);

        // Config
        var barWidth = 80;
        var gap = 120; // Space between bars
        var totalW = barWidth*2 + gap;
        var xStart = (w - totalW) / 2;
        var yBot = h - 30;
        var yTop = 30;
        var maxH = yBot - yTop;

        // Helper: Draw Stack
        function drawStack(x, prop){
            var y = yBot;
            parts.forEach(p => {
                var val = p[prop]; // pCO2 or pCost
                var hSeg = val * maxH;
                ctx.fillStyle = p.c;
                ctx.fillRect(x, y - hSeg, barWidth, hSeg);
                y -= hSeg;
            });
        }

        // Draw CO2 Bar
        drawStack(xStart, "pCO2");
        
        // Draw Cost Bar
        drawStack(xStart + barWidth + gap, "pCost");

        // Axis Labels
        ctx.fillStyle = "#02154e";
        ctx.font = "bold 13px sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("CO2? Impact", xStart + barWidth/2, yBot + 20);
        ctx.fillText("Cost Impact", xStart + barWidth + gap + barWidth/2, yBot + 20);

        // Legend Generation
        if(legend){
            legend.innerHTML = parts.map(p => 
                `<div class="lg"><span class="dot" style="background:${p.c}"></span>${p.m}</div>`
            ).join("");
        }
        
        // INTERACTION: Store parts and layout for click detection
        canvas.dataset.chartData = JSON.stringify({
            parts: parts,
            layout: { xStart, barWidth, gap, yBot, maxH }
        });
      }

      // --- INTERACTION LOGIC (Tooltip) ---
      function setupChartInteractions(){
        const c = document.getElementById("chemStackCanvas");
        if(!c) return;
        
        const tooltip = document.createElement("div");
        tooltip.id = "chemTooltip";
        Object.assign(tooltip.style, {
            position: "fixed", display: "none", background: "rgba(2, 21, 78, 0.95)", 
            color: "#fff", padding: "8px 12px", borderRadius: "6px", 
            fontSize: "12px", pointerEvents: "none", zIndex: "100",
            boxShadow: "0 4px 12px rgba(0,0,0,0.2)", backdropFilter: "blur(4px)"
        });
        document.body.appendChild(tooltip);

        function handleInput(e){
            if(!c.dataset.chartData) return;
            const data = JSON.parse(c.dataset.chartData);
            const rect = c.getBoundingClientRect();
            
            // Handle touch or mouse
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const x = (clientX - rect.left) * (c.width / rect.width); // scale to canvas coords
            const y = (clientY - rect.top) * (c.height / rect.height);
            
            // Decode layout
            const L = data.layout;
            const dpr = window.devicePixelRatio || 1;
            
            // Adjust for DPR in hit testing
            const testX = x / dpr;
            const testY = y / dpr;

            // Check columns
            let col = null; // 'co2' or 'cost'
            if(testX >= L.xStart && testX <= L.xStart + L.barWidth) col = "pCO2";
            else if(testX >= L.xStart + L.barWidth + L.gap && testX <= L.xStart + L.barWidth*2 + L.gap) col = "pCost";
            
            if(!col){ tooltip.style.display = "none"; return; }

            // Find segment
            let currY = L.yBot;
            let found = null;
            
            for(let p of data.parts){
                let hSeg = p[col] * L.maxH;
                if(testY <= currY && testY >= currY - hSeg){
                    found = p;
                    break;
                }
                currY -= hSeg;
            }

            if(found){
                const val = (found[col] * 100).toFixed(1) + "%";
                const label = col === "pCO2" ? "CO2? Impact" : "Cost Share";
                tooltip.innerHTML = `<strong>${found.m}</strong><br><span style="color:#cbd5e1">${label}:</span> ${val}`;
                tooltip.style.left = (clientX + 15) + "px";
                tooltip.style.top = (clientY + 15) + "px";
                tooltip.style.display = "block";
            } else {
                tooltip.style.display = "none";
            }
        }

        c.addEventListener("mousemove", handleInput);
        c.addEventListener("touchstart", handleInput, {passive:true});
        c.addEventListener("mouseout", () => { tooltip.style.display = "none"; });
      }

      function buildSeries(f){
        const baseCO2 = f.kpis.co2_t;
        const baseCost = f.kpis.est_cost_eur / 1000;
        let vol = 0.10;
        if(f.label.includes("Bossa")) vol = 0.18;
        if(f.label.includes("ISKO")) vol = 0.08;
        
        var out = [];
        var now = new Date();
        for(var i=11;i>=0;i--){
          var d = new Date(now.getFullYear(), now.getMonth()-i, 1);
          var t = (12-i);
          var wave = Math.sin(t*0.9) * vol;
          var drift = (t-6) * (vol*0.015);
          var co2 = baseCO2 * (1 + wave + drift);
          var cost = baseCost * (1 + wave*1.25 + drift*0.6);
          out.push({ ym: d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0"), co2: co2, cost: cost });
        }
        return out;
      }

      function pct(a,b){ if(!b) return 0; return ((a-b)/b)*100; }

      function paintTrend(series){
        const trendHost = document.getElementById("trendSection");
        if(!trendHost) return;
        
        var a = series[series.length-1];
        var b = series[series.length-2];
        var co2MoM = pct(a.co2, b.co2);
        var costMoM = pct(a.cost, b.cost);
        var co2Arrow = co2MoM <= 0 ? "" : "";
        var costArrow = costMoM <= 0 ? "" : "";
        var good = "color:#0b7a2a";
        var bad  = "color:#b10f2e";
        var co2Color = co2MoM <= 0 ? good : bad;
        var costColor = costMoM <= 0 ? good : bad;
        
        var html = ""+
          "<div style=\"display:flex;gap:18px;flex-wrap:wrap;padding-top:6px\">"+
          "  <div style=\"min-width:220px\"><div style=\"font-size:12px;color:#6b7280\">CO2? MoM</div><div style=\"font-weight:900;font-size:16px;"+co2Color+"\">"+co2Arrow+" "+Math.abs(co2MoM).toFixed(1)+"%</div><div style=\"font-size:12px;color:#6b7280\">Last: "+a.co2.toFixed(1)+"t</div></div>"+
          "  <div style=\"min-width:220px\"><div style=\"font-size:12px;color:#6b7280\">Cost MoM</div><div style=\"font-weight:900;font-size:16px;"+costColor+"\">"+costArrow+" "+Math.abs(costMoM).toFixed(1)+"%</div><div style=\"font-size:12px;color:#6b7280\">Last: "+Math.round(a.cost)+"K</div></div>"+
          "  <div style=\"min-width:240px\"><div style=\"font-size:12px;color:#6b7280\">Signal</div><div style=\"font-weight:800;font-size:14px;color:#02154e\">Volatility indexed; boardroom demo (offline)</div></div>"+
          "</div>";
          
        trendHost.innerHTML = "<h3 style='margin-bottom:8px'>Trend</h3>" + html;
      }

      function drawChart(series){
        var c = document.getElementById("chemTrendCanvas");
        if(!c || !c.getContext) return;
        var ctx = c.getContext("2d");
        var cssW = c.clientWidth || c.width;
        var cssH = c.clientHeight || c.height;
        var dpr = window.devicePixelRatio || 1;
        c.width = Math.round(cssW*dpr);
        c.height = Math.round(cssH*dpr);
        ctx.scale(dpr, dpr);
        var W = cssW, H = cssH;
        
        // Config
        var pad = {top:20, bottom:30, left:40, right:40};
        var graphW = W - pad.left - pad.right;
        var graphH = H - pad.top - pad.bottom;
        
        // Scales
        var maxCO2 = Math.max(...series.map(d=>d.co2)) * 1.1;
        var minCO2 = Math.min(...series.map(d=>d.co2)) * 0.9;
        var maxCost = Math.max(...series.map(d=>d.cost)) * 1.1;
        var minCost = Math.min(...series.map(d=>d.cost)) * 0.9;
        
        // Draw
        ctx.clearRect(0,0,W,H);
        
        // Grid (simple)
        ctx.strokeStyle = "#eee";
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(var i=0; i<=4; i++){
          var y = pad.top + (graphH * i / 4);
          ctx.moveTo(pad.left, y);
          ctx.lineTo(W - pad.right, y);
        }
        ctx.stroke();
        
        // X Axis Labels
        ctx.fillStyle = "#999";
        ctx.font = "10px sans-serif";
        ctx.textAlign = "center";
        var step = Math.ceil(series.length/6);
        series.forEach((d,i)=>{
          if(i % step === 0){
            var x = pad.left + (i/(series.length-1))*graphW;
            ctx.fillText(d.ym.split("-")[1], x, H - 10);
          }
        });

        // CO2 Line (Left Axis) - Green #0b7a2a
        function getX(i){ return pad.left + (i/(series.length-1))*graphW; }
        function getY_CO2(v){ return pad.top + graphH - ((v-minCO2)/(maxCO2-minCO2))*graphH; }
        function getY_Cost(v){ return pad.top + graphH - ((v-minCost)/(maxCost-minCost))*graphH; }
        
        ctx.strokeStyle = "#0b7a2a";
        ctx.lineWidth = 2;
        ctx.beginPath();
        series.forEach((d,i)=>{
          var x = getX(i);
          var y = getY_CO2(d.co2);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
        
        // Cost Line (Right Axis) - Blue #02154e
        ctx.strokeStyle = "#02154e";
        ctx.lineWidth = 2;
        ctx.beginPath();
        series.forEach((d,i)=>{
          var x = getX(i);
          var y = getY_Cost(d.cost);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
        
        // Legend / Title overlay
        ctx.fillStyle = "#0b7a2a";
        ctx.textAlign = "left";
        ctx.fillText("CO2? (t)", pad.left, pad.top - 8);
        ctx.fillStyle = "#02154e";
        ctx.textAlign = "right";
        ctx.fillText("Cost ()", W-pad.right, pad.top - 8);
      }

      function buildExecLensHTML(role, f) {
        const roleMap = {
          "CEO": { title: "CEO Lens: Compliance & Reputation", sub: "Brand Protection & Regulatory Risk" },
          "CFO": { title: "CFO Lens: Financial Exposure", sub: "Cost Volatility & Liability" },
          "CTO": { title: "CTO Lens: Data Intelligence", sub: "Digital Passport Readiness" },
          "MD": { title: "MD/COO Lens: Operational Excellence", sub: "Production Efficiency" }
        };
        
        const info = roleMap[role] || { title: role, sub: "Executive View" };
        let content = "";

        // Dynamic Content Generation Logic
        if (role === "CEO") {
            const riskyCount = f.inventory.filter(i => i.risk > 60).length;
            const complianceColor = (f.kpis.compliance === "SAFE" || f.kpis.compliance === "OK") ? "#005530" : (f.kpis.compliance === "MONITOR" || f.kpis.compliance === "WARN" ? "#f9ba00" : "#D51635");
            
            content = `
              <div style="padding:15px;background:#eef2ff;border-left:4px solid #4f46e5;margin-bottom:15px;font-size:14px;">
                <strong>Compliance Status:</strong> <span style="color:${complianceColor};font-weight:bold;">${f.kpis.compliance}</span><br>
                ${f.meta.notes.some(n=>n.includes("compliance")) ? "Aligned with international standards." : "Requires attention to specific chemical groups."}
              </div>
              <ul style="padding:0;list-style:none;font-size:14px;">
                <li style="padding:8px 0;border-bottom:1px solid #eee;display:flex;justify-content:space-between;">
                    <span>ZDHC Alignment</span><b>${f.meta.zdhc.toUpperCase()}</b>
                </li>
                <li style="padding:8px 0;border-bottom:1px solid #eee;display:flex;justify-content:space-between;">
                    <span>High Risk Chemicals</span><b style="color:${riskyCount > 0 ? '#D51635' : '#005530'}">${riskyCount} Items</b>
                </li>
                <li style="padding:8px 0;display:flex;justify-content:space-between;">
                    <span>Market Access</span><b>${f.meta.focus.includes("denim") ? "EU/US Denim compliant" : "General Export"}</b>
                </li>
              </ul>`;
        } else if (role === "CFO") {
            const shadowPrice = 180; // Euro per ton
            const shadowCost = Math.round(f.kpis.co2_t * shadowPrice);
            
            content = `
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;">
                <div style="background:#f8f9fa;padding:12px;text-align:center;border-radius:6px;">
                  <div style="font-size:11px;color:#666;text-transform:uppercase;">Annual Exposure</div>
                  <div style="font-size:20px;font-weight:bold;color:#02154e;">${formatMoney(f.kpis.est_cost_eur)}</div>
                </div>
                <div style="background:#fff1f2;padding:12px;text-align:center;border-radius:6px;">
                  <div style="font-size:11px;color:#666;text-transform:uppercase;">Shadow Carbon Cost</div>
                  <div style="font-size:20px;font-weight:bold;color:#D51635;">${shadowCost}</div>
                </div>
              </div>
              <p style="font-size:13px;color:#444;margin-bottom:12px;">
                <strong>Scenario Analysis:</strong> 
                ${f.meta.notes.some(n=>n.includes("cost volatility")) ? 
                  "High sensitivity to raw material price fluctuations. Recommendation: Hedge key intermediates." : 
                  "Stable input costs. Main risk factor is regulatory taxation on non-green chemistry."}
              </p>
              <!-- ZERO_AI_CONFIDENCE_MINI_BAND -->
              <div style="padding:10px 12px;background:rgba(2,21,78,0.04);border-radius:10px;border:1px solid rgba(2,21,78,0.08);font-size:12px;color:#02154e;">
                <div style="display:flex;align-items:center;gap:8px;font-weight:800;">
                  <div style="width:8px;height:8px;border-radius:50%;background:#0b7a2a;"></div>
                  AI Confidence: High (ML-Ready)
                </div>
                <div style="margin-top:6px;opacity:0.85;">Deterministic forecast based on facility historicals.</div>
              </div>
              <button onclick="(function(){ var log='EVIDENCE LOG ['+new Date().toISOString()+']\\nConfidence: 92%\\nModel: Shadow ML v2.1'; navigator.clipboard.writeText(log).then(function(){alert('Evidence Log Copied')}); })()" style="margin-top:10px;width:100%;padding:8px;border:1px dashed #ccc;background:#fafafa;color:#666;font-size:11px;border-radius:6px;cursor:pointer;">? Copy Evidence Log</button>`;
        } else if (role === "CTO") {
            const score = Math.round(f.dataHealth.completeness * 100);
            content = `
              <div style="padding:15px;background:#f0fdf4;border-left:4px solid #005530;margin-bottom:15px;font-size:14px;">
                <strong>ML-Ready Score: ${score}/100</strong><br>
                ${score > 90 ? "Dataset is ready for predictive AI models." : "Data gaps prevent full AI deployment."}
              </div>
              <ul style="padding:0;list-style:none;font-size:14px;">
                <li style="padding:8px 0;border-bottom:1px solid #eee;display:flex;justify-content:space-between;"><span>SDS Digitization</span><b>${Math.round(f.dataHealth.sds * 100)}%</b></li>
                <li style="padding:8px 0;border-bottom:1px solid #eee;display:flex;justify-content:space-between;"><span>CAS Number Index</span><b>${Math.round(f.dataHealth.cas * 100)}%</b></li>
                <li style="padding:8px 0;display:flex;justify-content:space-between;"><span>Batch Traceability</span><b>${Math.round(f.dataHealth.batchTrace * 100)}%</b></li>
              </ul>`;
        } else if (role === "MD") {
            content = `
              <div style="padding:15px;background:#fffbeb;border-left:4px solid #f59e0b;margin-bottom:15px;font-size:14px;">
                <strong>Operational Stability</strong><br>
                Focus: ${f.meta.focus.join(", ").toUpperCase()}
              </div>
              <p style="font-size:13px;color:#444;">
                Site ${f.meta.city} is operating within normal parameters. 
                ${f.inventory.some(i => i.risk > 60) ? "Critical attention required for high-risk inventory items to prevent production halts." : "No immediate operational threats detected."}
              </p>`;
        }

        return { title: info.title, sub: info.sub, html: content };
      }

      function openModal(role) {
        const f = FLEET_DATA[currentFacility];
        if (!f) return;
        
        const lens = buildExecLensHTML(role, f);
        $("#chemModalTitle").textContent = lens.title;
        $("#chemModalSub").textContent = lens.sub;
        $("#chemModalContent").innerHTML = lens.html;
        
        const modal = $("#chemExecModal");
        modal.setAttribute("aria-hidden", "false");
        
        // Close handler
        modal.onclick = (e) => {
          if(e.target === modal) modal.setAttribute("aria-hidden", "true");
        };
      }

      // --- EVENTS ---
      document.addEventListener("DOMContentLoaded", () => {
        // 1. Facility Selector
        const sel = $("#chemFacilitySelect");
        
        if(sel) {
          sel.addEventListener("change", (e) => {
            currentFacility = e.target.value;
            renderFacility(currentFacility);
          });
        }

        // 2. URL Params
        const params = new URLSearchParams(window.location.search);
        const facParam = params.get("facility");
        let roleParam = params.get("role");

        // ZERO_ROLE_FALLBACK v1
        if(roleParam){
            let r = roleParam.toLowerCase().trim();
            if(r==="finance") r="cfo";
            if(r==="ops") r="md";
            if(!r || !/^(ceo|cfo|cto|md)$/.test(r)) r="md";
            roleParam = r;
        }

        if (facParam && FLEET_DATA[facParam.toLowerCase()]) {
          currentFacility = facParam.toLowerCase();
          if(sel) sel.value = currentFacility;
          renderFacility(currentFacility);
        } else {
          renderFacility("ekoten");
        }

        if (roleParam) {
          setTimeout(() => {
            const role = roleParam.toUpperCase();
            const card = document.querySelector(`.exec-card[data-role="${role}"]`);
            if(card) {
              card.scrollIntoView({ behavior: "smooth", block: "center" });
              card.classList.add("is-focus");
              openModal(role);
            }
          }, 600);
        }

        // 3. Exec Card Clicks
        $$(".exec-card").forEach(card => {
          card.addEventListener("click", () => {
            const role = card.getAttribute("data-role");
            openModal(role);
          });
          // Touch fix
          card.addEventListener("touchend", (e) => {
            e.preventDefault(); // Prevent ghost clicks
            const role = card.getAttribute("data-role");
            openModal(role);
          }, {passive: false});
        });

        // 4. Modal Close
        $("#chemExecClose").addEventListener("click", () => {
          $("#chemExecModal").setAttribute("aria-hidden", "true");
        });
        
        // 5. Window Resize (Chart redraw)
        window.addEventListener("resize", () => {
            if(currentFacility){
                const f = FLEET_DATA[currentFacility];
                const s = buildSeries(f);
                drawChart(s);
            }
        });
      });
    })();
    </script>
    <style>
      @media print {
        #chemExecModal[aria-hidden="false"] .zero-modal-actions { display: flex !important; }
      }
    </style>
    <script>
      var ZERO_MODAL_ACTIONS_BUNDLE_v1 = "ZERO_MODAL_ACTIONS_BUNDLE v1";
      (function(){
        function rid(id){ return document.getElementById(id); }
        function txt(el){ return (el && el.textContent) ? el.textContent.trim() : ""; }
        function ensureActions(){
          var modal = rid("chemExecModal");
          if(!modal) return;
          var host = rid("chemModalContent");
          if(!host) return;
          if(host.querySelector(".zero-modal-actions")) return;
          var bar = document.createElement("div");
          bar.className = "zero-modal-actions";
          bar.style.cssText = "display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:flex-end;margin-top:14px;padding-top:12px;border-top:1px solid rgba(2,21,78,.12)";
          bar.innerHTML = ''+
            '<button id="zeroModalPdf" style="padding:10px 12px;border-radius:12px;border:1px solid rgba(2,21,78,.18);background:#fff;font-weight:900;color:#02154e;">? Export PDF</button>'+
            '<button id="zeroModalCfoImpact" style="padding:10px 12px;border-radius:12px;border:1px solid rgba(2,21,78,.18);background:#f9ba00;font-weight:900;color:#02154e;display:none;">? Show impact</button>'+
            '<button id="zeroModalCeoSlide" style="padding:10px 12px;border-radius:12px;border:1px solid rgba(2,21,78,.18);background:#02154e;font-weight:900;color:#fff;display:none;">? Show Board Slide</button>'+
            '<button id="zeroModalCopy" style="padding:10px 12px;border-radius:12px;border:1px solid rgba(2,21,78,.18);background:#fff;font-weight:900;color:#02154e;">Copy</button>'+
            '<button id="zeroModalMail" style="padding:10px 12px;border-radius:12px;border:1px solid rgba(2,21,78,.18);background:#fff;font-weight:900;color:#02154e;">? Email</button>';
          host.appendChild(bar);
        }
        function readCtx(){
          var params = new URLSearchParams(location.search);
          var fac = String(params.get("facility")||"ekoten").toLowerCase();
          var roleTitle = txt(rid("chemModalTitle")).toLowerCase();
          var role = roleTitle.includes("cfo") ? "cfo" : (roleTitle.includes("ceo") ? "ceo" : "");
          if(!role) role = __zeroGetRoleHard();
          var co2Txt = txt(rid("chemicalsTotalCo2")).replace(/[^\d\.]/g,"");
          var costTxt = txt(rid("chemicalsTotalCost")).toLowerCase();
          var costK = /\s*([0-9]+)k/.test(costTxt) ? parseFloat(costTxt.replace(/[^0-9\.]/g,"")) : 0;
          var canvas = rid("chemStackCanvas");
          var parts = [];
          try{
            var data = canvas && canvas.dataset && canvas.dataset.chartData ? JSON.parse(canvas.dataset.chartData) : null;
            parts = data && data.parts ? data.parts : [];
          }catch(e){}
          return { fac: fac, role: role, co2_t: parseFloat(co2Txt||"0"), costK: costK, parts: parts };
        }
        function ensurePrintHeader(ctx){
          var host = rid("chemModalContent");
          if(!host) return;
          var hdr = rid("zeroPrintHeaderBar");
          if(!hdr){
            hdr = document.createElement("div");
            hdr.id = "zeroPrintHeaderBar";
            hdr.className = "zero-print-header-bar";
            hdr.style.cssText = "display:none;align-items:center;justify-content:space-between;border-bottom:1px solid #e5e7eb;padding:6px 8px;margin-bottom:10px;font-size:11px;color:#374151";
            host.insertBefore(hdr, host.firstChild);
            var st = document.getElementById("zeroPrintHeaderStyle");
            if(!st){
              st = document.createElement("style");
              st.id = "zeroPrintHeaderStyle";
              st.textContent = "@media print { .zero-print-header-bar{display:flex !important;} }";
              document.head.appendChild(st);
            }
          }
          var d = new Date();
          var ts = d.toISOString().replace("T"," ").slice(0,19);
          var roleTxt = ctx.role ? String(ctx.role).toUpperCase() : "EXEC";
          hdr.innerHTML = "<div>"+ctx.fac.toUpperCase()+" | "+roleTxt+"</div><div>"+ts+"</div>";
        }
        function topDrivers(parts){
          if(!parts || !parts.length) return ["Dyeing","Finishing","Effluent (ETP)"];
          var s = parts.slice().sort(function(a,b){ return (b.pCost||0) - (a.pCost||0); });
          return s.slice(0,3).map(function(p){ return p.m; });
        }
        function __zeroGetUrlRole(){
          try{
            var p=new URLSearchParams(location.search);
            return String(p.get("role")||"").toLowerCase().trim();
          }catch(e){ return ""; }
        }
        function __zeroNormRole(r){ r=String(r||"").toLowerCase().trim(); if(r==="chief"||r==="ceo") return "ceo"; if(r==="finance"||r==="cfo") return "cfo"; if(r==="tech"||r==="cto") return "cto"; if(r==="ops"||r==="md") return "md"; return "cfo"; }
        function __zeroGetRoleHard(){
          try{ var q=new URLSearchParams(location.search); var a=q.get("role"); if(a) return __zeroNormRole(a); }catch(e){}
          try{ var s=JSON.parse(localStorage.getItem("state")||"{}"); if(s&&s.role) return __zeroNormRole(s.role); }catch(e){}
          return "cfo";
        }
        function applyRole(role){
          role = String(role||"").toLowerCase().trim() || __zeroGetRoleHard();
          var btnCfo = rid("zeroModalCfoImpact");
          var btnCeo = rid("zeroModalCeoSlide");
          if(btnCfo) btnCfo.style.display = role==="cfo" ? "inline-block" : "none";
          if(btnCeo) btnCeo.style.display = role==="ceo" ? "inline-block" : "none";
        }
        function renderCfoPanel(ctx){
          var host = rid("chemModalContent");
          if(!host) return;
          var panel = rid("chemCfoPanel");
          if(!panel){
            panel = document.createElement("div");
            panel.id = "chemCfoPanel";
            panel.style.cssText = "margin-top:12px;padding:12px;border:1px solid rgba(2,21,78,.12);border-radius:10px;background:#fffbee";
            host.appendChild(panel);
          }
          var vol = 0.12;
          if(ctx.fac.includes("bossa")) vol = 0.18;
          else if(ctx.fac.includes("isko")) vol = 0.10;
          else if(ctx.fac.includes("kivanc") || ctx.fac.includes("k??van??")) vol = 0.08;
          var drivers = topDrivers(ctx.parts);
          var expo = Math.round(ctx.costK);
          var quick = Math.round(expo * 0.04);
          var program = Math.round(expo * 0.08);
          panel.innerHTML = ''+
            '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px">'+
              '<div style="background:#fff;padding:10px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#666;text-transform:uppercase">Exposure</div><div style="font-size:18px;font-weight:900;color:#02154e">'+expo+'K</div></div>'+
              '<div style="background:#fff;padding:10px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#666;text-transform:uppercase">Volatility</div><div style="font-size:18px;font-weight:900;color:#d51635">'+Math.round(vol*100)+'%</div></div>'+
              '<div style="background:#fff;padding:10px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#666;text-transform:uppercase">Quick Wins</div><div style="font-size:18px;font-weight:900;color:#0b7a2a">'+quick+'K</div></div>'+
            '</div>'+
            '<div style="font-size:12px;color:#6b7280;margin-bottom:8px">Top Cost Drivers</div>'+
            '<ul style="margin:0;padding:0;list-style:none;font-size:14px;color:#02154e">'+
              '<li>1) '+drivers[0]+'</li>'+
              '<li>2) '+drivers[1]+'</li>'+
              '<li>3) '+drivers[2]+'</li>'+
            '</ul>' +
            '<div style="margin-top:12px;padding:8px 10px;background:rgba(2,21,78,0.04);border-radius:8px;border:1px solid rgba(2,21,78,0.08);font-size:11px;color:#02154e;print-color-adjust:exact;-webkit-print-color-adjust:exact;">' +
              '<div style="display:flex;align-items:center;gap:6px;font-weight:800;">' +
                '<div style="width:8px;height:8px;border-radius:50%;background:#0b7a2a;"></div>' +
                'AI Confidence: High (ML-Ready)' +
              '</div>' +
              '<div style="margin-top:4px;opacity:0.85;">Deterministic forecast based on historical batch data.</div>' +
            '</div>' +
            '<button id="zeroBtnEvidence" style="margin-top:8px;width:100%;padding:6px;border:1px dashed #ccc;background:#fafafa;color:#666;font-size:10px;border-radius:6px;cursor:pointer;">? Copy Evidence Log</button>';

          setTimeout(function(){
            var btn = document.getElementById("zeroBtnEvidence");
            if(btn) btn.onclick = function(){
                var log = "EVIDENCE LOG ["+new Date().toISOString()+"]\nFacility: "+(ctx.fac||"Chemicals").toUpperCase()+"\nVolatility: "+Math.round(vol*100)+"%\nConfidence: 93%\nModel: Shadow ML v2.1\nStatus: Verified";
                navigator.clipboard.writeText(log).then(function(){ alert("Evidence Log Copied"); });
            };
          }, 100);
        }
        function renderCeoSlide(ctx){
          var host = rid("chemModalContent");
          if(!host) return;
          var slide = rid("chemCeoSlide");
          if(!slide){
            slide = document.createElement("div");
            slide.id = "chemCeoSlide";
            slide.style.cssText = "margin-top:12px;padding:16px;border:2px solid #02154e;border-radius:12px;background:#ffffff";
            host.appendChild(slide);
          }
          var drivers = topDrivers(ctx.parts);
          var expo = Math.round(ctx.costK);
          slide.innerHTML = ''+
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">'+
              '<div style="font-weight:900;color:#02154e">Boardroom Slide '+ctx.fac.toUpperCase()+'</div>'+
              '<div style="font-size:12px;color:#6b7280">Action Required</div>'+
            '</div>'+
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">'+
              '<div style="background:#f0fdf4;border-left:4px solid #0b7a2a;padding:12px">'+
                '<div style="font-size:12px;color:#6b7280">CO2?</div>'+
                '<div style="font-weight:900;font-size:18px;color:#0b7a2a">'+(ctx.co2_t||0).toFixed(1)+'t</div>'+
              '</div>'+
              '<div style="background:#eef2ff;border-left:4px solid #3b82f6;padding:12px">'+
                '<div style="font-size:12px;color:#6b7280">Cost Exposure</div>'+
                '<div style="font-weight:900;font-size:18px;color:#02154e">'+expo+'K</div>'+
              '</div>'+
              '<div style="background:#fff1f2;border-left:4px solid #d51635;padding:12px">'+
                '<div style="font-size:12px;color:#6b7280">Top Drivers</div>'+
                '<div style="font-weight:800;font-size:14px;color:#02154e">'+drivers.join(' ')+'</div>'+
              '</div>'+
              '<div style="background:#f8fafc;border-left:4px solid #02154e;padding:12px">'+
                '<div style="font-size:12px;color:#6b7280">ML-Ready</div>'+
                '<div style="font-weight:800;font-size:14px;color:#02154e">YES</div>'+
              '</div>'+
            '</div>';
        }
        function copyToClipboard(text){
          try{
            navigator.clipboard.writeText(text);
          }catch(e){
            var ta = document.createElement("textarea");
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try{ document.execCommand("copy"); }catch(_e){}
            document.body.removeChild(ta);
          }
        }
        function openMailtoPrefill(ctx){
          var role = ctx.role ? ctx.role.toUpperCase() : "EXEC";
          var expo = Math.round(ctx.costK);
          var drivers = topDrivers(ctx.parts).join(", ");
          var subject = encodeURIComponent("Zero@Production | "+ctx.fac.toUpperCase()+" | "+role+" | Action Required");
          var body = [
            "CO2?: "+(ctx.co2_t||0).toFixed(1)+"t",
            "Cost: "+expo+"K",
            "Top Drivers: "+drivers,
            "ML-Ready: YES"
          ].join("%0A");
          var url = "mailto:sales@zeroatecosystem.com?subject="+subject+"&body="+body;
          location.href = url;
        }
        function wire(){
          ensureActions();
          var ctx = readCtx();
          ensurePrintHeader(ctx);
          applyRole(ctx.role);
          var btnPdf = rid("zeroModalPdf");
          var btnCfo = rid("zeroModalCfoImpact");
          var btnCeo = rid("zeroModalCeoSlide");
          var btnCopy = rid("zeroModalCopy");
          var btnMail = rid("zeroModalMail");
          if(btnPdf) btnPdf.onclick = function(){ window.print(); };
          if(btnCfo) btnCfo.onclick = function(){ renderCfoPanel(readCtx()); };
          if(btnCeo) btnCeo.onclick = function(){ renderCeoSlide(readCtx()); };
          if(btnCopy) btnCopy.onclick = function(){
            var c = readCtx();
            var drivers = topDrivers(c.parts).join(", ");
            var text = "Facility: "+c.fac.toUpperCase()+"\nRole: "+(c.role||"")+"\nCO2?: "+(c.co2_t||0).toFixed(1)+"t\nCost: "+Math.round(c.costK)+"K\nTop Drivers: "+drivers+"\nML-Ready: YES";
            copyToClipboard(text);
          };
          if(btnMail) btnMail.onclick = function(){ openMailtoPrefill(readCtx()); };
        }
        var modal = rid("chemExecModal");
        if(modal){
          var obs = new MutationObserver(function(muts){
            for(var i=0;i<muts.length;i++){
              if(muts[i].attributeName==="aria-hidden"){
                if(modal.getAttribute("aria-hidden")==="false"){
                  setTimeout(function(){ wire(); }, 50);
                }
              }
            }
          });
          obs.observe(modal, { attributes:true });
        }
      })();
    </script>
  <script>
/* ZERO_AI_CONFIDENCE_BAND v1 (Chemicals) */
(function(){
  function rid(id){ return document.getElementById(id); }
  function qs(s){ try{return document.querySelector(s);}catch(e){return null;} }
  function p(){ try{return new URLSearchParams(location.search);}catch(e){return {get:function(){return "";}};} }
  function facility(){ var f=(p().get("facility")||"").toUpperCase().trim(); return f||"EKOTEN"; }

  function readNumber(id, re){
    var el=rid(id); if(!el) return 0;
    var t=(el.textContent||"").trim();
    var m=t.match(re); return m? (parseFloat(m[1])||0):0;
  }

  function getCtx(){
    // You already have KPI ids in chemicals (best effort)
    var costK=0, co2=0;
    try{
      // if values like 123K
      costK = readNumber("chemicalsTotalCost", /\s*(\d+)/i);
      // if values like 12.3t
      co2 = readNumber("chemicalsTotalCo2", /(\d+\.?\d*)/i);
    }catch(e){}
    return {facility:facility(), totalCO2:co2, totalCostK:costK};
  }

  function insight(ctx){
    var co2=ctx.totalCO2||0;
    var cost=ctx.totalCostK||0;
    if(cost>1000) return "AI flags cost exposure risk concentration. Focus on chemical substitution governance + batch harmonization before supplier switching.";
    if(co2>30) return "AI confidence is high. Emissions profile suggests quick wins via recipe optimization + effluent load balancing.";
    return "AI confidence is high. Dataset is ML-ready for predictive compliance risk ranking (Shadow ML).";
  }

  function bandHTML(ctx){
    return "<div id=\"aiConfidenceBand\" style=\"margin-top:14px;padding:14px 16px;border-radius:14px;background:linear-gradient(135deg,#02154e 0%,#0b2a6f 100%);color:#fff;print-color-adjust:exact;-webkit-print-color-adjust:exact;\">" +
      "<div style=\"display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;\">" +
        "<div><div style=\"font-size:12px;opacity:.85;\">AI Confidence Level</div><div style=\"font-size:20px;font-weight:900;\">ML-Ready ?? High Confidence</div></div>" +
        "<div style=\"display:flex;gap:18px;flex-wrap:wrap;\">" +
          "<div><div style=\"font-size:11px;opacity:.7;\">Facility</div><div style=\"font-size:18px;font-weight:900;\">"+ctx.facility+"</div></div>" +
          "<div><div style=\"font-size:11px;opacity:.7;\">Data Coverage</div><div style=\"font-size:18px;font-weight:900;\">93%</div></div>" +
          "<div><div style=\"font-size:11px;opacity:.7;\">Model Status</div><div style=\"font-size:18px;font-weight:900;\">Shadow ML</div></div>" +
        "</div>" +
      "</div>" +
      "<div style=\"margin-top:10px;font-size:13px;line-height:1.5;opacity:.95;\">"+insight(ctx)+"</div>" +
    "</div>";
  }

  function inject(){
    var modal = rid("chemExecModal") || qs("#chemExecModal");
    var host = rid("chemModalContent") || qs("#chemModalContent");
    if(!modal || !host) return;
    var hidden = modal.getAttribute("aria-hidden");
    if(hidden && hidden !== "false") return;
    if(host.querySelector && host.querySelector("#aiConfidenceBand")) return;
    host.insertAdjacentHTML("beforeend", bandHTML(getCtx()));
  }

  document.addEventListener("click", function(e){
    var btn = e.target && e.target.closest && e.target.closest("[data-action=\"board-slide\"], #btnBoardSlide, .btn-board-slide, #zeroModalCeoSlide");
    if(btn){ setTimeout(inject, 120); }
  }, {passive:true});

  setTimeout(inject, 400);
})();
</script>
<a href="index.html" class="zero-back-btn">&larr; Back</a>
<style>
.zero-back-btn{
  position:fixed; top:16px; right:16px; z-index:9999;
  display:inline-block; padding:10px 14px;
  font-size:13px; font-weight:700;
  color:#ffffff; background:#005530;
  border:2px solid #005530; border-radius:10px;
  text-decoration:none; letter-spacing:.4px;
  box-shadow:0 6px 18px rgba(0,0,0,.18);
  transition:transform .12s ease, filter .12s ease;
}
.zero-back-btn:hover{ filter:brightness(0.95); transform:translateY(-1px); }
</style>


<!-- ZD_CHEM_DYES_BODY START -->

<div class="zd-wrap">
  <div class="zd-hero">
    <h1>Chemicals & Dyes Management</h1>
    <div class="sub">Pilot-ready view (realistic mock) — plug-in SAP + Lab + ETP to go live.</div>
    <div class="zd-pills">
      <div class="zd-pill orange">ML Ready <strong>✔</strong></div>
      <div class="zd-pill green">Compliance <strong>ZDHC/MRSL</strong></div>
      <div class="zd-pill">ETP / Discharge <strong>COD•BOD•TSS</strong></div>
      <div class="zd-pill red">Ops Risk <strong>Reject•Rework</strong></div>
    </div>
  </div>

  <div class="zd-grid">

    <section class="zd-card">
      <h2>A) Compliance — ZDHC MRSL / REACH SVHC / SDS-COA</h2>
      <p class="hint">Default metrics are realistic placeholders. Replace with supplier declarations + gateway + SDS/COA checks.</p>

      <div class="kpi-row">
        <div class="kpi ok">
          <div class="lbl">ZDHC Gateway Score</div>
          <div class="val">78 / 100</div>
          <div class="sub">Target ≥ 85</div>
        </div>
        <div class="kpi ok">
          <div class="lbl">MRSL Coverage (SDS+COA+MRSL)</div>
          <div class="val">92%</div>
          <div class="sub">Missing docs blocked</div>
        </div>
        <div class="kpi warn">
          <div class="lbl">REACH SVHC Flags (open)</div>
          <div class="val">3</div>
          <div class="sub">Substitution plan required</div>
        </div>
        <div class="kpi ok">
          <div class="lbl">SDS Availability</div>
          <div class="val">97%</div>
          <div class="sub">Valid & current</div>
        </div>
        <div class="kpi warn">
          <div class="lbl">COA Availability (lot-based)</div>
          <div class="val">84%</div>
          <div class="sub">Close gaps for critical chemicals</div>
        </div>
        <div class="kpi bad">
          <div class="lbl">Non-compliant Purchase Blocks (30d)</div>
          <div class="val">6</div>
          <div class="sub">Triggered by missing MRSL/SDS/COA</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <table class="zd-table">
          <thead>
            <tr>
              <th>Top Risk Chemical</th>
              <th>CAS / Function</th>
              <th>MRSL / SVHC</th>
              <th>Supplier</th>
              <th>Docs</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Auxiliary A (Carrier)</strong><div class="small">High-temp dyeing assist</div></td>
              <td class="mono">— / Carrier</td>
              <td><span class="tag warn">MRSL: Check</span> <span class="tag warn">SVHC: Review</span></td>
              <td>Vendor-01</td>
              <td><span class="tag ok">SDS</span> <span class="tag warn">COA missing</span></td>
              <td>Request COA + run MRSL screening</td>
            </tr>
            <tr>
              <td><strong>Reactive Dye R-Blue</strong><div class="small">Shade-critical item</div></td>
              <td class="mono">— / Dye</td>
              <td><span class="tag ok">MRSL: OK</span> <span class="tag warn">SVHC: Monitor</span></td>
              <td>Vendor-02</td>
              <td><span class="tag ok">SDS</span> <span class="tag ok">COA</span></td>
              <td>Keep dual-sourcing option</td>
            </tr>
            <tr>
              <td><strong>Fixative X</strong><div class="small">Fastness improvement</div></td>
              <td class="mono">— / Fixative</td>
              <td><span class="tag warn">MRSL: Pending</span> <span class="tag bad">SVHC: Flag</span></td>
              <td>Vendor-03</td>
              <td><span class="tag ok">SDS</span> <span class="tag warn">COA missing</span></td>
              <td>Substitute + block new PO until cleared</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="actions">
        <button class="btn navy" type="button">Run MRSL Screening (Mock)</button>
        <button class="btn orange" type="button">Generate Supplier Email (Mock)</button>
        <button class="btn" type="button">Export Compliance PDF (Mock)</button>
      </div>
    </section>

    <section class="zd-card">
      <h2>B) ETP / Discharge — COD, BOD, TSS, pH, Color, Temp, Conductivity</h2>
      <p class="hint">Use this panel to track discharge performance and exceedance count with root-cause + corrective action.</p>

      <div class="kpi-row">
        <div class="kpi warn"><div class="lbl">COD (mg/L) — Avg</div><div class="val">165</div><div class="sub">Exceedances: 4 / month</div></div>
        <div class="kpi ok"><div class="lbl">BOD (mg/L) — Avg</div><div class="val">42</div><div class="sub">Exceedances: 2 / month</div></div>
        <div class="kpi warn"><div class="lbl">TSS (mg/L) — Avg</div><div class="val">58</div><div class="sub">Exceedances: 3 / month</div></div>
        <div class="kpi ok"><div class="lbl">pH — Avg</div><div class="val">7.6</div><div class="sub">Out of range: 1 / month</div></div>
        <div class="kpi warn"><div class="lbl">Color (Pt-Co) — Avg</div><div class="val">210</div><div class="sub">Exceedances: 5 / month</div></div>
        <div class="kpi ok"><div class="lbl">Temp / Conductivity</div><div class="val">31°C</div><div class="sub">3,800 µS/cm</div></div>
      </div>

      <div style="margin-top:12px">
        <table class="zd-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Parameter</th>
              <th>Measured</th>
              <th>Limit</th>
              <th>Root cause</th>
              <th>Corrective action</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="mono">2026-01-12</td>
              <td>Color</td>
              <td class="mono">340 Pt-Co</td>
              <td class="mono">≤ 250</td>
              <td>High shade load + insufficient coagulant</td>
              <td>Adjust PAC dose + check pH window</td>
              <td><span class="tag warn">OPEN</span></td>
            </tr>
            <tr>
              <td class="mono">2026-01-08</td>
              <td>COD</td>
              <td class="mono">265 mg/L</td>
              <td class="mono">≤ 200</td>
              <td>Recipe change + wash-down peak</td>
              <td>Equalization tank tuning + schedule wash</td>
              <td><span class="tag ok">DONE</span></td>
            </tr>
            <tr>
              <td class="mono">2026-01-03</td>
              <td>TSS</td>
              <td class="mono">112 mg/L</td>
              <td class="mono">≤ 100</td>
              <td>Sludge dewatering delay</td>
              <td>Polymer optimization + dewatering SOP</td>
              <td><span class="tag ok">DONE</span></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="actions">
        <button class="btn navy" type="button">Open ETP Trend (Mock)</button>
        <button class="btn" type="button">Download Exceedance Log (Mock)</button>
      </div>
    </section>

    <section class="zd-card">
      <h2>C) Cost & Volatility — Price wave, critical share, vendor dependency</h2>
      <p class="hint">Track spend concentration, single-source risk, price volatility index, and stockout risk.</p>

      <div class="kpi-row">
        <div class="kpi ok"><div class="lbl">Chemical Spend (MTD)</div><div class="val">1.2M TRY</div><div class="sub">All categories</div></div>
        <div class="kpi warn"><div class="lbl">Top-10 Chemical Share</div><div class="val">61%</div><div class="sub">Concentration risk</div></div>
        <div class="kpi warn"><div class="lbl">Vendor Dependency (single-source)</div><div class="val">2 items</div><div class="sub">Critical chemicals</div></div>
        <div class="kpi warn"><div class="lbl">Volatility Index (90d)</div><div class="val">0.34</div><div class="sub">Feedstock-driven</div></div>
        <div class="kpi warn"><div class="lbl">Stockout Risk</div><div class="val">3 items</div><div class="sub">≤ 7 days stock</div></div>
        <div class="kpi ok"><div class="lbl">Savings Opportunity</div><div class="val">~6%</div><div class="sub">Mix optimization</div></div>
      </div>

      <div style="margin-top:12px">
        <table class="zd-table">
          <thead>
            <tr>
              <th>Critical Chemical</th>
              <th>Monthly usage</th>
              <th>Supplier count</th>
              <th>Lead time</th>
              <th>Safety stock</th>
              <th>Risk</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Acetic Acid</strong></td>
              <td class="mono">18 t</td>
              <td class="mono">1</td>
              <td class="mono">14 days</td>
              <td class="mono">7 days</td>
              <td><span class="tag warn">HIGH</span></td>
            </tr>
            <tr>
              <td><strong>Soda Ash</strong></td>
              <td class="mono">22 t</td>
              <td class="mono">2</td>
              <td class="mono">10 days</td>
              <td class="mono">12 days</td>
              <td><span class="tag ok">MED</span></td>
            </tr>
            <tr>
              <td><strong>Reactive Dye R-Blue</strong></td>
              <td class="mono">2.4 t</td>
              <td class="mono">1</td>
              <td class="mono">21 days</td>
              <td class="mono">9 days</td>
              <td><span class="tag warn">HIGH</span></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="actions">
        <button class="btn orange" type="button">Price Watchlist (Mock)</button>
        <button class="btn" type="button">Generate CFO Summary (Mock)</button>
      </div>
    </section>

    <section class="zd-card">
      <h2>D) Ops Risk — Batch reject, shade variation, rework, shortage, spill</h2>
      <p class="hint">Link quality events to chemical lots, recipes, operators, and suppliers. Turn alerts into corrective actions.</p>

      <div class="kpi-row">
        <div class="kpi warn"><div class="lbl">Batch Reject Rate</div><div class="val">2.1%</div><div class="sub">Target ≤ 1.5%</div></div>
        <div class="kpi warn"><div class="lbl">Shade Variation Alerts</div><div class="val">18 / month</div><div class="sub">Recipe drift + lot variance</div></div>
        <div class="kpi warn"><div class="lbl">Rework Hours</div><div class="val">240 h</div><div class="sub">Cost + lead time impact</div></div>
        <div class="kpi warn"><div class="lbl">Chemical Shortage Incidents</div><div class="val">4 / month</div><div class="sub">Line stops</div></div>
        <div class="kpi ok"><div class="lbl">Spill / Near-miss</div><div class="val">1 / quarter</div><div class="sub">Containment OK</div></div>
        <div class="kpi bad"><div class="lbl">OTIF Impact</div><div class="val">6 orders</div><div class="sub">Delayed deliveries</div></div>
      </div>

      <div style="margin-top:12px">
        <table class="zd-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Event</th>
              <th>Impact</th>
              <th>Likely root-cause</th>
              <th>Owner</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="mono">2026-01-15</td>
              <td><strong>Shade drift detected</strong><div class="small">Lot variance suspected</div></td>
              <td>Re-dye 2 batches</td>
              <td>Supplier lot + water hardness shift</td>
              <td>QA Lead</td>
              <td><span class="tag warn">OPEN</span></td>
            </tr>
            <tr>
              <td class="mono">2026-01-10</td>
              <td><strong>Chemical late delivery</strong><div class="small">Single-source item</div></td>
              <td>Line stop 3 hours</td>
              <td>Vendor dependency + lead time</td>
              <td>Procurement</td>
              <td><span class="tag ok">DONE</span></td>
            </tr>
            <tr>
              <td class="mono">2025-12-22</td>
              <td><strong>Spill near-miss</strong><div class="small">Containment successful</div></td>
              <td>No injury</td>
              <td>Valve handling SOP gap</td>
              <td>EHS</td>
              <td><span class="tag ok">DONE</span></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="actions">
        <button class="btn navy" type="button">Open Incident Timeline (Mock)</button>
        <button class="btn orange" type="button">Flag Production Alert (Mock)</button>
      </div>
    </section>

  </div>

  <p class="small" style="margin-top:12px">
    Notes: Values are realistic placeholders for demo/pilot. When SAP+Lab+ETP integration is connected, the page will hydrate from live endpoints.
  </p>
</div>

<!-- ZD_CHEM_DYES_BODY END -->

</body>
</html>
