<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zero@SaaS — Ops</title>

  <style>
    :root{
      --navy:#02154e;
      --navy2:#081a3a;
      --panel:#0b1224;
      --panel2:#0f172a;
      --text:#e6eefc;
      --muted:#9fb0d0;
      --line:#1e2a46;
      --orange:#f9ba00;
      --green:#00c17a;
      --red:#d51635;
      --chip:#0c1a38;
      --shadow: 0 24px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 35% 15%, rgba(249,186,0,.18), transparent 55%),
        radial-gradient(900px 500px at 70% 35%, rgba(0,193,122,.10), transparent 55%),
        radial-gradient(900px 500px at 30% 70%, rgba(213,22,53,.10), transparent 55%),
        linear-gradient(180deg, #050915 0%, #030610 100%);
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(90deg, var(--navy) 0%, #031a60 40%, var(--navy) 100%);
      border-bottom:1px solid rgba(255,255,255,.06);
      padding: 14px 18px;
    }
    .topbar-inner{
      max-width: 1100px;
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 260px;
    }
    .logo{
      width:34px; height:34px;
      border-radius:10px;
      background: rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,.12);
    }
    .brand h1{
      font-size:14px; margin:0; line-height:1.1;
      letter-spacing:.2px;
    }
    .brand .sub{
      font-size:12px; color:rgba(230,238,252,.75);
      margin-top:2px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(230,238,252,.9);
      font-size:12px;
      white-space:nowrap;
    }
    .pill .dot{
      width:8px;height:8px;border-radius:99px;background:var(--orange);
      box-shadow:0 0 0 3px rgba(249,186,0,.18);
    }
    .actions{display:flex; gap:10px; align-items:center;}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      text-decoration:none;
      font-size:12px;
      cursor:pointer;
    }
    .btn:hover{filter:brightness(1.08);}
    .btn.primary{
      background: var(--orange);
      color:#0b1224;
      border-color: rgba(0,0,0,.25);
      font-weight:700;
    }

    .wrap{max-width:1100px; margin: 28px auto 60px; padding: 0 16px;}
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(10px);
    }

    .panel-header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:18px;
      margin-bottom: 14px;
    }
    .panel-title{ font-size:16px; margin:0; }
    .panel-desc{
      margin:4px 0 0;
      color: rgba(230,238,252,.70);
      font-size:12px;
    }

    .kpi-row{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin: 14px 0 16px;
    }
    .kpi{
      background: rgba(2,21,78,.35);
      border:1px solid rgba(255,255,255,.07);
      border-radius: 14px;
      padding: 12px 12px;
      display:flex; flex-direction:column; gap:6px;
      min-height: 64px;
    }
    .kpi .val{
      font-size:18px; font-weight:800;
      letter-spacing:.2px;
    }
    .kpi .lbl{
      font-size:12px;
      color: rgba(230,238,252,.70);
    }
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      width:fit-content;
    }
    .badge.ok{ color: #b9ffdf; border-color: rgba(0,193,122,.35); background: rgba(0,193,122,.12); }
    .badge.mon{ color: #ffe2a6; border-color: rgba(249,186,0,.40); background: rgba(249,186,0,.12); }
    .badge.crit{ color: #ffb7c3; border-color: rgba(213,22,53,.40); background: rgba(213,22,53,.12); }

    .mid{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
      align-items: stretch;
    }
    .card{
      background: rgba(3,10,24,.55);
      border:1px solid rgba(255,255,255,.07);
      border-radius: 16px;
      padding: 14px;
    }
    .card h3{
      margin:0 0 8px;
      font-size:13px;
      color: rgba(230,238,252,.92);
    }
    .card .hint{
      color: rgba(230,238,252,.60);
      font-size:11px;
      margin: 0 0 10px;
    }
    .card-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .chip{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      font-size: 11px;
      color: rgba(230,238,252,.75);
      white-space:nowrap;
    }
    .canvas-wrap{ height: 240px; position: relative; }
    canvas{max-width:100% !important; max-height:100% !important;}

    .gauge{ display:flex; flex-direction:column; gap:10px; }
    .gauge-box{
      background: rgba(255,255,255,.04);
      border:1px dashed rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 12px;
    }
    .gauge-metrics{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .mini{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 10px;
    }
    .mini .big{ font-size:16px; font-weight:800; }
    .mini .small{ font-size:11px; color: rgba(230,238,252,.65); margin-top:3px; }

    .bridge{
      margin-top: 12px;
      background: rgba(3,10,24,.55);
      border:1px solid rgba(255,255,255,.07);
      border-radius: 16px;
      padding: 12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:14px;
    }
    .bridge p{
      margin:0;
      font-size:12px;
      color: rgba(230,238,252,.70);
    }

    @media (max-width: 980px){
      .kpi-row{grid-template-columns: repeat(2, 1fr);}
      .mid{grid-template-columns: 1fr;}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">⚡</div>
        <div>
          <h1>Zero@SaaS @ Ops</h1>
          <div class="sub">Production — Textile • Batch Passport</div>
        </div>
        <div class="pill"><span class="dot"></span> ML-Ready</div>
      </div>

      <div class="actions">
        <select class="btn" id="facilitySelect" title="Facility">
          <option value="MERKEZ" selected>MERKEZ</option>
          <option value="ORGU">ORGU</option>
        </select>
        <a class="btn" href="../index.html">Executive</a>
        <a class="btn" href="./ops.html">Ops</a>
        <a class="btn" href="./wastewater.html">Wastewater</a>
        <a class="btn" href="../index.html">← Back</a>
        <a class="btn primary" href="#" id="btnExecPdf">Executive PDF</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2 class="panel-title">Operations Dashboard</h2>
          <p class="panel-desc">Dark view — gauges + trends. Executive decision layer stays clean; Ops layer shows control signals.</p>
        </div>
        <div class="pill"><span class="dot"></span> live-feel (demo)</div>
      </div>

      <div class="kpi-row">
        <div class="kpi">
          <div class="val" id="kpiWaterIntensity">--</div>
          <div class="lbl">water intensity (m³/ton)</div>
        </div>
        <div class="kpi">
          <div class="val" id="kpiYoY">--</div>
          <div class="lbl">YoY change</div>
        </div>
        <div class="kpi">
          <div class="val"><span class="badge mon" id="kpiIntensityStatus">--</span></div>
          <div class="lbl">intensity status</div>
        </div>
        <div class="kpi">
          <div class="val"><span class="badge ok" id="kpiAnomalyStatus">--</span></div>
          <div class="lbl">anomaly status</div>
        </div>
      </div>

      <div class="mid">
        <div class="card">
          <div class="card-top">
            <h3>Trends</h3>
            <div class="chip" id="chipFacility">MERKEZ • 2022–2025</div>
          </div>
          <p class="hint">Water intensity + recycle (from Supabase view <b>v_water_intelligence</b>).</p>
          <div class="canvas-wrap">
            <canvas id="waterTrendChart"></canvas>
          </div>
        </div>

        <div class="card gauge">
          <div class="card-top">
            <h3>Gauge</h3>
            <div class="chip">ops signal</div>
          </div>
          <p class="hint">Simple radial gauge based on current intensity.</p>

          <div class="gauge-box">
            <div class="canvas-wrap" style="height:200px;">
              <canvas id="waterGauge"></canvas>
            </div>

            <div class="gauge-metrics">
              <div class="mini">
                <div class="big" id="gaugeNow">--</div>
                <div class="small">current m³/ton</div>
              </div>
              <div class="mini">
                <div class="big" id="gaugeFlag">--</div>
                <div class="small">exec flag</div>
              </div>
            </div>

            <div style="margin-top:10px; font-size:11px; color: rgba(230,238,252,.60);">
              Executive detail: if this signal persists, expected annual impact can be shown (demo-safe estimate).
            </div>
          </div>
        </div>
      </div>

      <div class="bridge">
        <p><b>Executive Bridge:</b> Ops signals become CFO language (€ / year). Next step: connect to real batch KPIs / Supabase view.</p>
        <span class="badge" style="background:rgba(255,255,255,.06);">Ops → CFO</span>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ✅ Supabase config + loader (your existing stack) -->
  <script src="../assets/js/supabase.fabric.config.js"></script>
  <script src="../assets/js/supabase.fabric.loader.js"></script>

  <script>
    function $(id){ return document.getElementById(id); }

    function badgeClass(el, kind){
      if(!el) return;
      el.classList.remove('ok','mon','crit');
      if(kind==='OK' || kind==='STABLE') el.classList.add('ok');
      else if(kind==='MONITOR' || kind==='ANOMALY_UP') el.classList.add('mon');
      else if(kind==='ALERT' || kind==='CRITICAL') el.classList.add('crit');
      else el.classList.add('mon');
    }

    function toNum(x){
      if(x==null) return null;
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    function fmtPct(x){
      const n = toNum(x);
      if(n==null) return '--';
      return (n>=0?'+':'') + n.toFixed(1) + '%';
    }

    let waterChart = null;
    let gaugeChart = null;

    function renderTrend(labels, intensity, recycle){
      const el = $('waterTrendChart');
      if(!el || typeof Chart === 'undefined') return;

      if(waterChart) waterChart.destroy();

      waterChart = new Chart(el, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Water Intensity (m³/ton)', data: intensity, borderColor: '#f9ba00', tension: 0.3 },
            { label: 'Recycle %', data: recycle, borderColor: '#00c17a', tension: 0.3 }
          ]
        },
        options: {
          maintainAspectRatio:false,
          plugins: { legend: { labels: { color: '#e6eefc' } } },
          scales: {
            x: { ticks: { color: '#9fb0d0' }, grid: { color: 'rgba(255,255,255,.06)' } },
            y: { ticks: { color: '#9fb0d0' }, grid: { color: 'rgba(255,255,255,.06)' } }
          }
        }
      });
    }

    function renderGauge(value){
      const el = $('waterGauge');
      if(!el || typeof Chart === 'undefined') return;

      const v = toNum(value);
      const max = 100;
      const safe = v==null ? 0 : Math.max(0, Math.min(max, v));

      if(gaugeChart) gaugeChart.destroy();

      gaugeChart = new Chart(el, {
        type: 'doughnut',
        data: {
          labels: ['value','rest'],
          datasets: [{
            data: [safe, max-safe],
            backgroundColor: ['#f9ba00', 'rgba(255,255,255,.08)'],
            borderWidth: 0
          }]
        },
        options: {
          maintainAspectRatio:false,
          cutout: '78%',
          rotation: -90,
          circumference: 180,
          plugins: { legend: { display:false }, tooltip: { enabled:false } }
        }
      });

      $('gaugeNow').innerText = (v==null ? '--' : v.toFixed(1)) + ' m³/ton';
    }

    function pickClient(){
      return window.supabaseClient || window.supabase || window.client || null;
    }

    function demoFallback(facilityCode){
      console.warn('[OPS] Demo fallback active.');
      const demo = {
        MERKEZ: { years:[2022,2023,2024,2025], m3:[66.4,79.1,86.6,83.0], r:[0.0,5.1,8.7,7.4], yoy:-4.2, ist:'MONITOR', an:'STABLE' },
        ORGU:   { years:[2022,2023,2024,2025], m3:[2.09,1.95,2.# (ONLY the missing tail — paste this after your current cut point)
# ... you ended at:  ORGU:   { years:[2022,2023,2024,2025], m3:[2.09,1.95,2.

85], r:[0,0,0,0], yoy:153.3, ist:'OK', an:'ANOMALY_UP' }
      };
      const d = demo[facilityCode] || demo.MERKEZ;
      const latestM3 = d.m3[d.m3.length-1];

      $('chipFacility').innerText = facilityCode + ' • ' + d.years[0] + '–' + d.years[d.years.length-1];
      $('kpiWaterIntensity').innerText = latestM3.toFixed(1) + ' m³/ton';
      $('kpiYoY').innerText = fmtPct(d.yoy);

      $('kpiIntensityStatus').innerText = d.ist;
      badgeClass($('kpiIntensityStatus'), d.ist);

      $('kpiAnomalyStatus').innerText = d.an;
      badgeClass($('kpiAnomalyStatus'), d.an);

      $('gaugeFlag').innerText = d.ist;
      badgeClass($('gaugeFlag'), d.ist);

      renderTrend(d.years, d.m3, d.r);
      renderGauge(latestM3);
    }

    async function loadWater(facilityCode){
      const client = pickClient();
      if(!client || !client.from){
        demoFallback(facilityCode);
        return;
      }

      const { data, error } = await client
        .from('v_water_intelligence')
        .select('*')
        .eq('facility_code', facilityCode)
        .order('year', { ascending: true });

      if(error){
        console.error('[OPS] Water fetch error:', error);
        demoFallback(facilityCode);
        return;
      }

      if(!data || !data.length){
        console.warn('[OPS] No rows returned for', facilityCode);
        demoFallback(facilityCode);
        return;
      }

      const labels    = data.map(d => d.year);
      const intensity = data.map(d => toNum(d.m3_per_ton));
      const recycle   = data.map(d => toNum(d.recycle_pct));
      const latest    = data[data.length-1];

      $('chipFacility').innerText = facilityCode + ' • ' + labels[0] + '–' + labels[labels.length-1];
      $('kpiWaterIntensity').innerText =
        (toNum(latest.m3_per_ton)==null ? '--' : toNum(latest.m3_per_ton).toFixed(1)) + ' m³/ton';
      $('kpiYoY').innerText = fmtPct(latest.yoy_pct_change);

      const ist = latest.intensity_status || '--';
      const an  = latest.anomaly_status || 'STABLE';

      $('kpiIntensityStatus').innerText = ist;
      badgeClass($('kpiIntensityStatus'), ist);

      $('kpiAnomalyStatus').innerText = an;
      badgeClass($('kpiAnomalyStatus'), an);

      $('gaugeFlag').innerText = ist;
      badgeClass($('gaugeFlag'), ist);

      renderTrend(labels, intensity, recycle);
      renderGauge(latest.m3_per_ton);
    }

    function wire(){
      const sel = $('facilitySelect');
      if(sel){
        sel.addEventListener('change', () => loadWater(sel.value));
      }

      const btn = $('btnExecPdf');
      if(btn){
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          alert('Executive PDF: wire this to your existing export flow (demo-safe).');
        });
      }

      const initial = sel ? sel.value : 'MERKEZ';
      loadWater(initial);
    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', wire);
    } else {
      wire();
    }
  </script>
</body>
</html>
