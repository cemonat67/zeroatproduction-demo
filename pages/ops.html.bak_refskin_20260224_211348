<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zero@SaaS  Ops</title>

  <style>
    
.zp-execpdf{
  background: var(--orange) !important;
  color:#061021 !important;
  border-color: rgba(0,0,0,.25) !important;
  box-shadow: 0 0 0 3px rgba(249,186,0,.18) !important;
}

/* === OPS_THEME_REF_V1 (navy + green, reference-like) === */
:root{
  --navy:#02154e;
  --bg:#050915;
  --panel:#0b1224;
  --panel2:#0f1a33;
  --card:#121c2f;
  --card2:#16223a;
  --stroke:rgba(255,255,255,.08);
  --stroke2:rgba(255,255,255,.12);
  --text:#e9f1ff;
  --muted:#9fb0d0;

  \1#48c05a\3     /* reference green */
  \1#2f6bff\3      /* reference blue */
  \1#66d1ff\3      /* light cyan line */
  --amber:#f5b400;
  --red:#d51635;
}

/* page bg */
body{
  background:
    radial-gradient(1200px 500px at 40% -10%, rgba(47,107,255,.22), transparent 60%),
    radial-gradient(900px 520px at 92% 10%, rgba(72,192,90,.08), transparent 55%),
    linear-gradient(180deg, var(--bg) 0%, #030610 100%);
  color: var(--text);
}

/* top nav stays navy */
.topbar{
  background: linear-gradient(90deg, var(--navy) 0%, #031a60 40%, var(--navy) 100%) !important;
  border-bottom: 1px solid rgba(255,255,255,.05);
}

/* main shell */
.shell, .panel, .wrap, .ops-wrap{
  background: rgba(11,18,36,.55);
}

/* cards */
.card, .kpi, .kpi-card, .panel-card{
  background: linear-gradient(180deg, rgba(18,28,47,.92), rgba(15,26,51,.88));
  border: 1px solid var(--stroke);
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
}

/* inner panels */
.box, .tile, .trend, .gauge, .section{
  background: rgba(18,28,47,.72);
  border: 1px solid rgba(255,255,255,.05);
}

/* inputs */
select, input, .btn{
  border: 1px solid rgba(255,255,255,.10) !important;
}

/* primary button: green like reference */
.btn.primary{
  background: #0f1f3d !important;
  color: var(--text) !important;
  border-color: rgba(255,255,255,.14) !important;
  font-weight: 900 !important;
  box-shadow: 0 0 0 3px rgba(47,107,255,.16);
}

/* pills/badges */
.badge.ok, .pill.ok{
  color:#caffe0;
  border-color: rgba(72,192,90,.35);
  background: rgba(72,192,90,.14);
}
.badge.mon, .pill.mon{
  color:#ffe7a6;
  border-color: rgba(245,180,0,.45);
  background: rgba(245,180,0,.14);
}
.badge.crit, .pill.crit{
  color:#ffb7c3;
  border-color: rgba(213,22,53,.45);
  background: rgba(213,22,53,.14);
}

/* chart canvas containers */
canvas{
  filter: drop-shadow(0 10px 20px rgba(0,0,0,.25));
}

html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 35% 15%, rgba(249,186,0,.18), transparent 55%),
        radial-gradient(900px 500px at 70% 35%, rgba(0,193,122,.10), transparent 55%),
        radial-gradient(900px 500px at 30% 70%, rgba(213,22,53,.10), transparent 55%),
        linear-gradient(180deg, #050915 0%, #030610 100%);
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(90deg, var(--navy) 0%, #031a60 40%, var(--navy) 100%);
      border-bottom:1px solid rgba(255,255,255,.05);
      padding: 14px 18px;
    }
    .topbar-inner{
      max-width: 1100px;
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 260px;
    }
    .logo{
      width:34px; height:34px;
      border-radius:10px;
      background: rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,.12);
    }
    .brand h1{
      font-size:14px; margin:0; line-height:1.1;
      letter-spacing:.2px;
    }
    .brand .sub{
      font-size:12px; color:rgba(230,238,252,.75);
      margin-top:2px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(230,238,252,.9);
      font-size:12px;
      white-space:nowrap;
    }
    .pill .dot{
      width:8px;height:8px;border-radius:99px;background:var(--green);
      box-shadow:0 0 0 3px rgba(72,192,90,.08);
    }
    .actions{display:flex; gap:10px; align-items:center;}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      text-decoration:none;
      font-size:12px;
      cursor:pointer;
    }
    .btn:hover{filter:brightness(1.08);}
    .btn.primary{
  background: #0f1f3d !important;
  color: var(--text) !important;
  border-color: rgba(255,255,255,.14) !important;
  font-weight: 900 !important;
  box-shadow: 0 0 0 3px rgba(47,107,255,.16);
}

    .wrap{max-width:1100px; margin: 28px auto 60px; padding: 0 16px;}
    .panel{
      background: linear-gradient(180deg, rgba(0,193,122,.10), rgba(255,255,255,.02));
      border: 1px solid rgba(0,193,122,.18);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(10px);
    }

    .panel-header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:18px;
      margin-bottom: 14px;
    }
    .panel-title{ font-size:16px; margin:0; }
    .panel-desc{
      margin:4px 0 0;
      color: rgba(230,238,252,.70);
      font-size:12px;
    }

    .kpi-row{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin: 14px 0 16px;
    }
    .kpi{
      background: rgba(11,26,22,.62);
      border:1px solid rgba(0,193,122,.18);
      border-radius: 14px;
      padding: 12px 12px;
      display:flex; flex-direction:column; gap:6px;
      min-height: 64px;
    }
    .kpi .val{
      font-size:18px; font-weight:800;
      letter-spacing:.2px;
    }
    .kpi .lbl{
      font-size:12px;
      color: rgba(230,238,252,.70);
    }
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      width:fit-content;
    }
    .badge.ok{ color:#caffe0; border-color: rgba(72,192,90,.35); background: rgba(72,192,90,.14); }
    .badge.mon{ color:#ffe7a6; border-color: rgba(245,180,0,.45); background: rgba(245,180,0,.14); }
    .badge.crit{ color:#ffb7c3; border-color: rgba(213,22,53,.45); background: rgba(213,22,53,.14); }

    .mid{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
      align-items: stretch;
    }
    .card{
      background: rgba(11,26,22,.55);
      border:1px solid rgba(0,193,122,.18);
      border-radius: 16px;
      padding: 14px;
    }
    .card h3{
      margin:0 0 8px;
      font-size:13px;
      color: rgba(230,238,252,.92);
    }
    .card .hint{
      color: rgba(230,238,252,.60);
      font-size:11px;
      margin: 0 0 10px;
    }
    .card-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .chip{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,193,122,.06);
      border: 1px solid rgba(0,193,122,.18);
      font-size: 11px;
      color: rgba(230,238,252,.75);
      white-space:nowrap;
    }
    .canvas-wrap{ height: 240px; position: relative; }
    canvas{max-width:100% !important; max-height:100% !important;}

    .gauge{ display:flex; flex-direction:column; gap:10px; }
    .gauge-box{
      background: rgba(255,255,255,.03);
      border:1px dashed rgba(0,193,122,.25);
      border-radius: 16px;
      padding: 12px;
    }
    .gauge-metrics{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .mini{
      background: rgba(0,193,122,.06);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 10px;
    }
    .mini .big{ font-size:16px; font-weight:800; }
    .mini .small{ font-size:11px; color: rgba(230,238,252,.65); margin-top:3px; }

    .bridge{
      margin-top: 12px;
      background: rgba(11,26,22,.55);
      border:1px solid rgba(0,193,122,.18);
      border-radius: 16px;
      padding: 12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:14px;
    }
    .bridge p{
      margin:0;
      font-size:12px;
      color: rgba(230,238,252,.70);
    }

    @media (max-width: 980px){
      .kpi-row{grid-template-columns: repeat(2, 1fr);}
      .mid{grid-template-columns: 1fr;}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Zero@SaaS @ Ops</h1>
          <div class="sub">Production  Textile  Batch Passport</div>
        </div>
        <div class="pill"><span class="dot"></span> ML-Ready</div>
      </div>

      <div class="actions">
        <select class="btn" id="facilitySelect" title="Facility">
          <option value="MERKEZ" selected>MERKEZ</option>
          <option value="ORGU">ORGU</option>
        </select>
        <a class="btn" href="../index.html">Executive</a>
        <a class="btn" href="./ops.html">Ops</a>
        <a class="btn" href="./wastewater.html">Wastewater</a>
        <a class="btn" href="../index.html"> Back</a>
        <a class="btn primary" href="#" id="btnExecPdf" class="btn primary zp-execpdf">Executive PDF</a>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2 class="panel-title">Operations Dashboard</h2>
          <p class="panel-desc">Dark view  gauges + trends. Executive decision layer stays clean; Ops layer shows control signals.</p>
        </div>
        <div class="pill"><span class="dot"></span> live-feel (demo)</div>
      </div>

      <div class="kpi-row">
        <div class="kpi">
          <div class="val" id="kpiWaterIntensity">--</div>
          <div class="lbl">water intensity (m/ton)</div>
        </div>
        <div class="kpi">
          <div class="val" id="kpiYoY">--</div>
          <div class="lbl">YoY change</div>
        </div>
        <div class="kpi">
          <div class="val"><span class="badge mon" id="kpiIntensityStatus">--</span></div>
          <div class="lbl">intensity status</div>
        </div>
        <div class="kpi">
          <div class="val"><span class="badge ok" id="kpiAnomalyStatus">--</span></div>
          <div class="lbl">anomaly status</div>
        </div>
      </div>

      <div class="mid">
        <div class="card">
          <div class="card-top">
            <h3>Trends</h3>
            <div class="chip" id="chipFacility">MERKEZ  20222025</div>
          </div>
          <p class="hint">Water intensity + recycle (from Supabase view <b>v_water_intelligence</b>).</p>
          <div class="canvas-wrap">
            <canvas id="waterTrendChart"></canvas>
          </div>
        </div>

        <div class="card gauge">
          <div class="card-top">
            <h3>Gauge</h3>
            <div class="chip">ops signal</div>
          </div>
          <p class="hint">Simple radial gauge based on current intensity.</p>

          <div class="gauge-box">
            <div class="canvas-wrap" style="height:200px;">
              <canvas id="waterGauge"></canvas>
            </div>

            <div class="gauge-metrics">
              <div class="mini">
                <div class="big" id="gaugeNow">--</div>
                <div class="small">current m/ton</div>
              </div>
              <div class="mini">
                <div class="big" id="gaugeFlag">--</div>
                <div class="small">exec flag</div>
              </div>
            </div>

            <div style="margin-top:10px; font-size:11px; color: rgba(230,238,252,.60);">
              Executive detail: if this signal persists, expected annual impact can be shown (demo-safe estimate).
            </div>
          </div>
        </div>
      </div>

      <div class="bridge">
        <p><b>Executive Bridge:</b> Ops signals become CFO language ( / year). Next step: connect to real batch KPIs / Supabase view.</p>
        <span class="badge" style="background:rgba(255,255,255,.05);">Ops  CFO</span>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!--  Supabase config + loader (your existing stack) -->
  <script src="../assets/js/supabase.fabric.config.js"></script>

  <!--  Supabase JS (CDN) + client bootstrap for ops.html -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  (function(){
    try{
      if(window.supabaseClient) return;

      var base = (window.SUPABASE_URL || window.__SUPABASE_URL || window.ZERO_SUPABASE_URL || window.supabaseUrl || "").replace(/\/+$/, "");
      var anon = window.SUPABASE_ANON_KEY || window.__SUPABASE_ANON_KEY || window.ZERO_SUPABASE_ANON_KEY || window.supabaseAnonKey || window.SUPABASE_KEY || "";
      var schema = window.SUPABASE_SCHEMA || "public";

      if(!base || !anon){ console.warn("[OPS] Supabase config missing"); return; }
      if(!window.supabase || !window.supabase.createClient){ console.warn("[OPS] supabase-js not loaded"); return; }

      window.supabaseClient = window.supabase.createClient(base, anon, { db: { schema: schema } });
      console.log("[OPS] supabaseClient ready", base, schema);
    } catch(e){
      console.warn("[OPS] supabaseClient bootstrap failed", e);
    }
  })();
  </script>


  <script>
    function $(id){ return document.getElementById(id); }

    function badgeClass(el, kind){
      if(!el) return;
      el.classList.remove('ok','mon','crit');
      if(kind==='OK' || kind==='STABLE') el.classList.add('ok');
      else if(kind==='MONITOR' || kind==='ANOMALY_UP') el.classList.add('mon');
      else if(kind==='ALERT' || kind==='CRITICAL') el.classList.add('crit');
      else el.classList.add('mon');
    }

    function toNum(x){
      if(x==null) return null;
      const n = Number(x);
      return Number.isFinite(n) ? n : null;
    }

    function fmtPct(x){
      const n = toNum(x);
      if(n==null) return '--';
      return (n>=0?'+':'') + n.toFixed(1) + '%';
    }

    let waterChart = null;
    let gaugeChart = null;

    function renderTrend(labels, intensity, recycle){
      const el = $('waterTrendChart');
      if(!el || typeof Chart === 'undefined') return;

      if(waterChart) waterChart.destroy();

      waterChart = new Chart(el, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Water Intensity (m/ton)', data: intensity, borderColor: 'var(--blue)', tension: 0.3 },
            { label: 'Recycle %', data: recycle, borderColor: 'var(--cyan)', tension: 0.3 }
          ]
        },
        options: {
          maintainAspectRatio:false,
          plugins: { legend: { labels: { color: '#e6eefc' } } },
          scales: {
            x: { ticks: { color: '#9fb0d0' }, grid: { color: 'rgba(255,255,255,.05)' } },
            y: { ticks: { color: '#9fb0d0' }, grid: { color: 'rgba(255,255,255,.05)' } }
          }
        }
      });
    }

    function renderGauge(value){
      const el = $('waterGauge');
      if(!el || typeof Chart === 'undefined') return;

      const v = toNum(value);
      const max = 100;
      const safe = v==null ? 0 : Math.max(0, Math.min(max, v));

      if(gaugeChart) gaugeChart.destroy();

      gaugeChart = new Chart(el, {
        type: 'doughnut',
        data: {
          labels: ['value','rest'],
          datasets: [{
            data: [safe, max-safe],
            backgroundColor: ['var(--cyan)', 'rgba(255,255,255,.08)'],
            borderWidth: 0
          }]
        },
        options: {
          maintainAspectRatio:false,
          cutout: '78%',
          rotation: -90,
          circumference: 180,
          plugins: { legend: { display:false }, tooltip: { enabled:false } }
        }
      });

      $('gaugeNow').innerText = (v==null ? '--' : v.toFixed(1)) + ' m/ton';
    }

    function pickClient(){
      return window.supabaseClient || window.supabase || window.client || null;
    }

    function demoFallback(facilityCode){
      console.warn('[OPS] Demo fallback active.');
      const demo = {
        MERKEZ: { years:[2022,2023,2024,2025], m3:[66.4,79.1,86.6,83.0], r:[0.0,5.1,8.7,7.4], yoy:-4.2, ist:'MONITOR', an:'STABLE' },
        ORGU:   { years:[2022,2023,2024,2025], m3:[2.09,1.95,2. (ONLY the missing tail  paste this after your current cut point)

85], r:[0,0,0,0], yoy:153.3, ist:'OK', an:'ANOMALY_UP' }
      };
      const d = demo[facilityCode] || demo.MERKEZ;
      const latestM3 = d.m3[d.m3.length-1];

      $('chipFacility').innerText = facilityCode + '  ' + d.years[0] + '' + d.years[d.years.length-1];
      $('kpiWaterIntensity').innerText = latestM3.toFixed(1) + ' m/ton';
      $('kpiYoY').innerText = fmtPct(d.yoy);

      $('kpiIntensityStatus').innerText = d.ist;
      badgeClass($('kpiIntensityStatus'), d.ist);

      $('kpiAnomalyStatus').innerText = d.an;
      badgeClass($('kpiAnomalyStatus'), d.an);

      $('gaugeFlag').innerText = d.ist;
      badgeClass($('gaugeFlag'), d.ist);

      renderTrend(d.years, d.m3, d.r);
      renderGauge(latestM3);
    }

    async function loadWater(facilityCode){
      const client = pickClient();
      if(!client || !client.from){
        demoFallback(facilityCode);
        return;
      }

      const { data, error } = await client
        .from('v_water_intelligence')
        .select('*')
        .eq('facility_code', facilityCode)
        .order('year', { ascending: true });

      if(error){
        console.error('[OPS] Water fetch error:', error);
        demoFallback(facilityCode);
        return;
      }

      if(!data || !data.length){
        console.warn('[OPS] No rows returned for', facilityCode);
        demoFallback(facilityCode);
        return;
      }

      const labels    = data.map(d => d.year);
      const intensity = data.map(d => toNum(d.m3_per_ton));
      const recycle   = data.map(d => toNum(d.recycle_pct));
      const latest    = data[data.length-1];

      $('chipFacility').innerText = facilityCode + '  ' + labels[0] + '' + labels[labels.length-1];
      $('kpiWaterIntensity').innerText =
        (toNum(latest.m3_per_ton)==null ? '--' : toNum(latest.m3_per_ton).toFixed(1)) + ' m/ton';
      $('kpiYoY').innerText = fmtPct(latest.yoy_pct_change);

      const ist = latest.intensity_status || '--';
      const an  = latest.anomaly_status || 'STABLE';

      $('kpiIntensityStatus').innerText = ist;
      badgeClass($('kpiIntensityStatus'), ist);

      $('kpiAnomalyStatus').innerText = an;
      badgeClass($('kpiAnomalyStatus'), an);

      $('gaugeFlag').innerText = ist;
      badgeClass($('gaugeFlag'), ist);

      renderTrend(labels, intensity, recycle);
      renderGauge(latest.m3_per_ton);
    }

    function wire(){
      const sel = $('facilitySelect');
      if(sel){
        sel.addEventListener('change', () => loadWater(sel.value));
      }

      const btn = $('btnExecPdf');
      if(btn){
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          alert('Executive PDF: wire this to your existing export flow (demo-safe).');
        });
      }

      const initial = sel ? sel.value : 'MERKEZ';
      loadWater(initial);
    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', wire);
    } else {
      wire();
    }
  </script>
</body>
</html>

<script>
(function(){
  'use strict';

  function $(id){ return document.getElementById(id); }

  function setText(id, v){
    var el = $(id);
    if(!el) return;
    el.textContent = (v==null ? '--' : String(v));
  }

  function setBadge(id, kind){
    var el = $(id);
    if(!el) return;
    el.textContent = kind || '--';
    el.classList.remove('ok','mon','crit');
    if(kind==='OK' || kind==='STABLE') el.classList.add('ok');
    else if(kind==='MONITOR' || kind==='ANOMALY_UP') el.classList.add('mon');
    else if(kind==='ALERT' || kind==='CRITICAL') el.classList.add('crit');
    else el.classList.add('mon');
  }

  function toNum(x){
    if(x==null || x==='') return null;
    var n = Number(x);
    return Number.isFinite(n) ? n : null;
  }

  function fmt1(n){
    var x = toNum(n);
    return x==null ? '--' : x.toFixed(1);
  }

  function fmtPct(n){
    var x = toNum(n);
    if(x==null) return '--';
    return (x>=0?'+':'') + x.toFixed(1) + '%';
  }

  // --- chart holders (reuse your existing functions if already defined) ---
  var waterChart = null;
  var gaugeChart = null;

  function renderTrend(labels, intensity, recycle){
    var el = $('waterTrendChart');
    if(!el || typeof Chart === 'undefined') return;
    if(waterChart) waterChart.destroy();

    waterChart = new Chart(el, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          { label: 'Water Intensity (m³/ton)', data: intensity, borderColor: 'var(--blue)', tension: 0.3 },
          { label: 'Recycle %', data: recycle, borderColor: 'var(--cyan)', tension: 0.3 }
        ]
      },
      options: {
        maintainAspectRatio:false,
        plugins: { legend: { labels: { color: '#e6eefc' } } },
        scales: {
          x: { ticks: { color: '#9fb0d0' }, grid: { color: 'rgba(255,255,255,.05)' } },
          y: { ticks: { color: '#9fb0d0' }, grid: { color: 'rgba(255,255,255,.05)' } }
        }
      }
    });
  }

  function renderGauge(value){
    var el = $('waterGauge');
    if(!el || typeof Chart === 'undefined') return;

    var v = toNum(value);
    var max = 100;
    var safe = (v==null) ? 0 : Math.max(0, Math.min(max, v));

    if(gaugeChart) gaugeChart.destroy();

    gaugeChart = new Chart(el, {
      type: 'doughnut',
      data: {
        labels: ['value','rest'],
        datasets: [{
          data: [safe, max-safe],
          backgroundColor: ['#1E78FF', 'rgba(255,255,255,.08)'],
          borderWidth: 0
        }]
      },
      options: {
        maintainAspectRatio:false,
        cutout: '78%',
        rotation: -90,
        circumference: 180,
        plugins: { legend: { display:false }, tooltip: { enabled:false } }
      }
    });

    setText('gaugeNow', (v==null ? '--' : v.toFixed(1)) + ' m³/ton');
  }

  // --- DB fetch ---
  async function fetchWaterIntelligence(facilityCode){
    var c = window.supabaseClient;
    if(!c) throw new Error('supabaseClient missing');

    // NOTE: adapt column names if different in your view
    // expected: year, water_intensity_m3_per_ton, recycle_pct, yoy_change_pct, intensity_status, anomaly_status
    var res = await c
      .from('v_water_intelligence')
      .select('*')
      .eq('facility_code', facilityCode)
      .order('year', { ascending: true });

    if(res.error) throw res.error;
    return res.data || [];
  }

  function computeExecFlag(intensity){
    var v = toNum(intensity);
    if(v==null) return '--';
    if(v >= 85) return 'ALERT';
    if(v >= 75) return 'MONITOR';
    return 'OK';
  }

  function applyRows(facilityCode, rows){
    // labels + series
    var labels = rows.map(function(r){ return String(r.year ?? r.y ?? r.period ?? ''); }).filter(Boolean);
    var intensity = rows.map(function(r){
      return toNum(r.water_intensity_m3_per_ton ?? r.water_intensity ?? r.m3_per_ton);
    });
    var recycle = rows.map(function(r){
      return toNum(r.recycle_pct ?? r.recycle ?? r.recycle_percent);
    });

    // last row KPIs
    var last = rows.length ? rows[rows.length-1] : null;
    var lastIntensity = last ? toNum(last.water_intensity_m3_per_ton ?? last.water_intensity ?? last.m3_per_ton) : null;
    var yoy = last ? toNum(last.yoy_change_pct ?? last.yoy ?? last.yoy_pct) : null;

    setText('chipFacility', facilityCode + ' • ' + (labels[0] || '—') + '–' + (labels[labels.length-1] || '—'));
    setText('kpiWaterIntensity', (lastIntensity==null ? '--' : lastIntensity.toFixed(1)) + ' m³/ton');
    setText('kpiYoY', fmtPct(yoy));

    var ist = last ? (last.intensity_status ?? last.intensity_flag ?? 'MONITOR') : '--';
    var an  = last ? (last.anomaly_status ?? last.anomaly_flag ?? 'STABLE') : '--';
    setBadge('kpiIntensityStatus', String(ist));
    setBadge('kpiAnomalyStatus', String(an));

    setText('gaugeFlag', computeExecFlag(lastIntensity));

    renderTrend(labels, intensity, recycle);
    renderGauge(lastIntensity);
  }

  function demoFallback(facilityCode){
    console.warn('[OPS] Demo fallback active.');
    var demo = {
      MERKEZ: { years:[2022,2023,2024,2025], m3:[66.4,79.1,86.6,83.0], r:[0.0,5.1,8.7,7.4], yoy:-4.2, ist:'MONITOR', an:'STABLE' },
      ORGU:   { years:[2022,2023,2024,2025], m3:[2.09,1.95,2.12,2.04], r:[0.0,1.2,1.5,1.4], yoy:-3.8, ist:'OK', an:'STABLE' }
    };
    var d = demo[facilityCode] || demo.MERKEZ;
    var rows = d.years.map(function(y, i){
      return {
        year: y,
        water_intensity_m3_per_ton: d.m3[i],
        recycle_pct: d.r[i],
        yoy_change_pct: (i===d.years.length-1 ? d.yoy : null),
        intensity_status: d.ist,
        anomaly_status: d.an
      };
    });
    applyRows(facilityCode, rows);
  }

  async function loadFacility(facilityCode){
    try{
      var rows = await fetchWaterIntelligence(facilityCode);
      if(!rows || !rows.length){
        console.warn('[OPS] no rows, using demo fallback');
        return demoFallback(facilityCode);
      }
      applyRows(facilityCode, rows);
    } catch(e){
      console.warn('[OPS] load failed, fallback', e);
      demoFallback(facilityCode);
    }
  }

  function bind(){
    var sel = $('facilitySelect');
    if(!sel) return;

    sel.addEventListener('change', function(){
      var code = sel.value || 'MERKEZ';
      loadFacility(code);
    });

    var init = sel.value || 'MERKEZ';
    loadFacility(init);
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bind);
  } else {
    bind();
  }
})();
</script>

